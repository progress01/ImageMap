<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map ç”Ÿæˆå™¨ V14 (V8é¢¨æ ¼+æ¸…å–®å¢å¼·)</title>
    <style>
        /* --- V8 é¢¨æ ¼åŸºç¤æ¨£å¼ --- */
        body { 
            font-family: "Microsoft JhengHei", -apple-system, sans-serif; 
            background: #f4f6f8; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; margin: 0; 
            /* ç§»é™¤ height: 100vhï¼Œè®“é é¢è‡ªç„¶æ²å‹• */
        }
        h1 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        /* --- åœ“è§’æ§åˆ¶åˆ— --- */
        .main-controls { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .file-group, .toolbar { 
            background: white; padding: 10px 20px; border-radius: 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; 
        }
        .toolbar { margin-bottom: 20px; flex-wrap: wrap; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        button { 
            padding: 8px 18px; border: 1px solid #ddd; background: #fff; border-radius: 20px; 
            cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; 
            display: flex; align-items: center; gap: 5px; 
        }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        button.danger { color: #dc3545; border-color: #dc3545; }
        button.info { color: #17a2b8; border-color: #17a2b8; }
        button.note { color: #6610f2; border-color: #6610f2; }
        
        /* å´é‚Šæ¬„é–‹é—œæŒ‰éˆ• (æ·±è‰²) */
        button.toggle-sidebar { background: #343a40; color: white; border-color: #343a40; }
        button.toggle-sidebar.off { background: #fff; color: #333; border-color: #ddd; }

        input[type="text"].filename-input { padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; width: 180px; text-align: center; }
        input[type="text"].filename-input:focus { border-color: #28a745; }

        /* --- ä¸»è¦å·¥ä½œå€ (Flex ä½ˆå±€) --- */
        .workspace-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            max-width: 100%;
        }

        /* --- ç•«å¸ƒå®¹å™¨ (V8 é¢¨æ ¼å›æ­¸) --- */
        #canvas-wrapper { 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border: 4px solid white; 
            border-radius: 4px; 
            overflow: auto; /* å…è¨±å…§éƒ¨æ²å‹• */
            background: #ddd; 
            /* é™åˆ¶æœ€å¤§å¯¬é«˜ï¼Œé¿å…æ’çˆ†è¢å¹•ï¼Œä½†ä¿ç•™ V8 çš„æ¡†æ¡†æ„Ÿ */
            max-width: 90vw; 
            max-height: 80vh;
            min-width: 600px; 
            min-height: 400px;
        }
        
        canvas { 
            display: block; 
            cursor: crosshair; 
            transform-origin: top left; /* ç¸®æ”¾éŒ¨é» */
        }

        /* --- ç¸®æ”¾å·¥å…·åˆ— (æ‡¸æµ®åœ¨ç•«å¸ƒå·¦ä¸‹è§’) --- */
        .zoom-toolbar {
            position: absolute; bottom: 15px; left: 15px;
            background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 25px;
            display: flex; gap: 8px; align-items: center;
            color: white; font-size: 0.85rem; z-index: 10; pointer-events: auto;
        }
        .zoom-btn { 
            background: transparent; border: 1px solid #999; color: white; 
            padding: 2px 8px; border-radius: 10px; font-size: 12px; height: auto;
        }
        .zoom-btn:hover { background: #28a745; border-color: #28a745; }

        /* --- å´é‚Šæ¸…å–®é¢æ¿ (ç¨ç«‹å¡ç‰‡) --- */
        .sidebar-card {
            width: 260px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            transition: all 0.3s ease;
            opacity: 1;
        }
        
        .sidebar-card.hidden {
            width: 0; padding: 0; opacity: 0; margin-left: -20px; pointer-events: none;
        }

        .panel-header {
            padding: 15px; background: #333; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-header h3 { margin: 0; font-size: 1rem; color: #fff; }
        
        .layer-list { flex: 1; overflow-y: auto; padding: 10px; min-height: 200px; }
        
        .layer-item {
            background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s; border-left: 4px solid transparent;
            display: flex; flex-direction: column; gap: 5px;
        }
        .layer-item:hover { background: #eee; }
        .layer-item.active { 
            background: #fffbe6; border-color: #ffe58f; border-left-color: #faad14; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .layer-top { display: flex; justify-content: space-between; align-items: center; }
        .layer-title { font-weight: bold; font-size: 0.95em; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 140px; }
        .layer-actions { display: flex; gap: 5px; justify-content: flex-end; margin-top: 5px; }
        
        .mini-btn { padding: 2px 8px; font-size: 0.8em; height: auto; border-radius: 4px; border:1px solid #ccc; }
        .mini-btn.del:hover { background: #dc3545; color: white; border-color: #dc3545; }
        .mini-btn.edit:hover { background: #007bff; color: white; border-color: #007bff; }

        .empty-state { text-align: center; color: #999; padding: 30px 10px; font-size: 0.9em; }

        /* --- ç·¨è¼¯ Modal (ä¿ç•™ V8 æ¨£å¼) --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .editor-modal.show { visibility: visible; opacity: 1; }
        .editor-card { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; }
        .editor-card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }
        
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1em; }
        textarea { width: 100%; height: 160px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 1em; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>Image Map ç”Ÿæˆå™¨ V14</h1>
    <div class="subtitle">V8 ç¶“å…¸ä»‹é¢ + V13 ç¸®æ”¾èˆ‡æ¸…å–®åŠŸèƒ½</div>

    <div class="main-controls">
        <div class="file-group">
            <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 1: æª”æ¡ˆ</span>
            <button onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
            <input type="file" id="imgInput" accept="image/*" style="display:none">
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <button class="info" onclick="document.getElementById('importInput').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="importInput" accept=".html" style="display:none">
        </div>
    </div>

    <div class="toolbar">
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 2: ç·¨è¼¯</span>
        <button id="btnRect" class="active" onclick="setTool('rect')">ç•«çŸ©å½¢</button>
        <button id="btnPoly" onclick="setTool('poly')">ç•«å¤šé‚Šå½¢</button>
        <button class="note" onclick="editGlobalNote()">ğŸ“ å°ˆæ¡ˆç­†è¨˜</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button id="btnToggleSidebar" class="toggle-sidebar" onclick="toggleSidebar()">ğŸ—‚ï¸ é¡¯ç¤º/éš±è—æ¸…å–®</button>
        <button class="danger" onclick="clearAll()">æ¸…é™¤</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 3: ä¸‹è¼‰</span>
        <input type="text" id="fileNameInput" class="filename-input" placeholder="æª”æ¡ˆåç¨±">
        <button class="primary" onclick="downloadPresentation()">ğŸ“¥ ä¸‹è¼‰ HTML</button>
    </div>

    <div class="workspace-container">
        
        <div id="canvas-wrapper">
            <canvas id="editorCanvas"></canvas>
            
            <div class="zoom-toolbar">
                <span id="zoomLabel" style="min-width:40px">100%</span>
                <button class="zoom-btn" onclick="fitToScreen()">Fit</button>
                <button class="zoom-btn" onclick="setZoom(1)">1:1</button>
                <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
                <button class="zoom-btn" onclick="changeZoom(-0.1)">-</button>
            </div>
        </div>

        <div class="sidebar-card" id="sidebarCard">
            <div class="panel-header">
                <h3>å·²å»ºç«‹é …ç›® (<span id="shapeCount">0</span>)</h3>
            </div>
            <div class="layer-list" id="layerList">
                <div class="empty-state">å°šç„¡é …ç›®<br>è«‹åœ¨åœ–ç‰‡ä¸Šç¹ªè£½</div>
            </div>
        </div>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-card">
            <h3 id="modalTitle">ğŸ“ ç·¨è¼¯å€åŸŸè³‡è¨Š</h3>
            <div id="titleGroup">
                <label>æ¨™é¡Œ</label>
                <input type="text" id="inputTitle" placeholder="æ¨™é¡Œ">
            </div>
            <div>
                <label>è©³ç´°å…§å®¹ (æ”¯æ´ HTML)</label>
                <textarea id="inputDesc" placeholder="å…§å®¹èªªæ˜..."></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="cancelModal()">å–æ¶ˆ</button>
                <button class="primary" onclick="saveModal()">ç¢ºå®šå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const imgInput = document.getElementById('imgInput');
        const importInput = document.getElementById('importInput');
        const modal = document.getElementById('editorModal');
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');
        const fileNameInput = document.getElementById('fileNameInput');
        const layerListEl = document.getElementById('layerList');
        const shapeCountEl = document.getElementById('shapeCount');
        const sidebarCard = document.getElementById('sidebarCard');
        const btnToggleSidebar = document.getElementById('btnToggleSidebar');
        const zoomLabel = document.getElementById('zoomLabel');

        let image = new Image();
        let shapes = []; let currentShape = null; let tempShape = null;
        let isDrawing = false; let tool = 'rect'; 
        let originalImageDataUrl = ""; let globalNote = ""; let isEditingNote = false;
        let focusedShapeIndex = -1; let editingShapeIndex = -1;

        // V13 ç¸®æ”¾æ ¸å¿ƒ
        let currentScale = 1.0;

        // åˆå§‹åŒ–
        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#666"; ctx.font = "20px sans-serif"; ctx.fillText("è«‹ä¸Šå‚³åœ–ç‰‡ (V14)", 320, 250);

        // --- å´é‚Šæ¬„é–‹é—œ ---
        function toggleSidebar() {
            sidebarCard.classList.toggle('hidden');
            if (sidebarCard.classList.contains('hidden')) {
                btnToggleSidebar.classList.add('off');
                btnToggleSidebar.innerText = "ğŸ—‚ï¸ é¡¯ç¤ºæ¸…å–®";
            } else {
                btnToggleSidebar.classList.remove('off');
                btnToggleSidebar.innerText = "ğŸ—‚ï¸ éš±è—æ¸…å–®";
            }
        }

        // --- åœ–ç‰‡è™•ç† ---
        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result);
                shapes = []; globalNote = ""; 
                fileNameInput.value = file.name.split('.')[0];
                renderLayers();
            };
            reader.readAsDataURL(file);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const doc = new DOMParser().parseFromString(event.target.result, 'text/html');
                const script = doc.getElementById('restore-data');
                if (script) {
                    const data = JSON.parse(script.textContent);
                    shapes = data.shapes; globalNote = data.globalNote || "";
                    loadImage(data.imgData);
                    fileNameInput.value = file.name.split('.')[0];
                    renderLayers();
                    alert("å°ˆæ¡ˆå·²é‚„åŸï¼");
                } else { alert("æ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsText(file);
            importInput.value = '';
        });

        function loadImage(src) {
            originalImageDataUrl = src;
            image.onload = () => {
                canvas.width = image.width; canvas.height = image.height;
                // é è¨­åšä¸€æ¬¡ Fitï¼Œé¿å…å¤§åœ–ç›´æ¥æ’çˆ†
                fitToScreen();
                redraw();
            };
            image.src = src;
        }

        // --- ç¸®æ”¾é‚è¼¯ (V13) ---
        function setZoom(scale) {
            currentScale = scale;
            if(currentScale < 0.1) currentScale = 0.1;
            // ä½¿ç”¨ CSS æ§åˆ¶é¡¯ç¤ºå¤§å°
            canvas.style.width = (canvas.width * currentScale) + "px";
            canvas.style.height = (canvas.height * currentScale) + "px";
            zoomLabel.innerText = Math.round(currentScale * 100) + "%";
        }

        function changeZoom(delta) { setZoom(currentScale + delta); }

        function fitToScreen() {
            if(!image.src) return;
            // è®“åœ–ç‰‡é©æ‡‰å®¹å™¨ (V8å®¹å™¨å¤§å°)
            const wrapperW = canvasWrapper.clientWidth - 40;
            const wrapperH = window.innerHeight * 0.7; // æ¦‚æŠ“é«˜åº¦
            const scaleX = wrapperW / image.width;
            const scaleY = wrapperH / image.height;
            let newScale = Math.min(scaleX, scaleY);
            if(newScale > 1) newScale = 1; 
            setZoom(newScale);
        }

        // --- ç¹ªåœ–é‚è¼¯ (V13 åº§æ¨™ä¿®æ­£) ---
        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null; redraw();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // é—œéµï¼šé™¤ä»¥ currentScale è½‰å›åŸå§‹åº§æ¨™
            return { 
                x: (e.clientX - rect.left) / currentScale, 
                y: (e.clientY - rect.top) / currentScale 
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            
            // é»æ“Šå–æ¶ˆèšç„¦
            if(focusedShapeIndex !== -1 && !isDrawing) {
                focusedShapeIndex = -1; renderLayers(); redraw();
            }

            if (tool === 'rect') { isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos }; } 
            else { if (!currentShape) currentShape = { type: 'poly', points: [pos] }; else currentShape.points.push(pos); }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) { currentShape.end = pos; redraw(); }
            else if (tool === 'poly' && currentShape) {
                redraw(); ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2 / currentScale; ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 5) openEditor(currentShape, -1);
                currentShape = null; redraw();
            }
        });

        canvas.addEventListener('dblclick', () => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                openEditor(currentShape, -1); currentShape = null; redraw();
            }
        });

        // --- æ¸…å–®èˆ‡ç·¨è¼¯é‚è¼¯ ---
        function renderLayers() {
            layerListEl.innerHTML = '';
            shapeCountEl.innerText = shapes.length;
            if(shapes.length === 0) {
                layerListEl.innerHTML = '<div class="empty-state">å°šç„¡é …ç›®</div>'; return;
            }
            shapes.forEach((s, idx) => {
                const item = document.createElement('div');
                item.className = `layer-item ${idx === focusedShapeIndex ? 'active' : ''}`;
                item.onclick = () => focusShape(idx);
                item.innerHTML = `
                    <div class="layer-top">
                        <span class="layer-title">${s.title}</span>
                        <span style="font-size:0.8em; color:#888;">${s.type==='rect'?'çŸ©å½¢':'å¤šé‚Šå½¢'}</span>
                    </div>
                    <div class="layer-actions">
                        <button class="mini-btn edit" onclick="event.stopPropagation(); editShape(${idx})">âœï¸</button>
                        <button class="mini-btn del" onclick="event.stopPropagation(); deleteShape(${idx})">ğŸ—‘ï¸</button>
                    </div>
                `;
                layerListEl.appendChild(item);
            });
        }

        function focusShape(index) {
            focusedShapeIndex = index;
            renderLayers(); redraw();
            
            // è‡ªå‹•æ²å‹• (V13é‚è¼¯)
            const s = shapes[index];
            let cx, cy;
            if(s.type==='rect') { cx = (s.start.x+s.end.x)/2; cy = (s.start.y+s.end.y)/2; }
            else { cx = s.points[0].x; cy = s.points[0].y; }
            
            const scrollX = (cx * currentScale) - (canvasWrapper.clientWidth / 2);
            const scrollY = (cy * currentScale) - (canvasWrapper.clientHeight / 2);
            canvasWrapper.scrollTo({ left: scrollX, top: scrollY, behavior: 'smooth' });
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            const lw = 2 / currentScale; // ç·šå¯¬éš¨ç¸®æ”¾èª¿æ•´

            shapes.forEach((s, idx) => {
                const isActive = (idx === focusedShapeIndex);
                drawShape(s, true, isActive, lw);
            });
            if (currentShape) drawShape(currentShape, false, false, lw);
        }

        function drawShape(s, confirmed, active, lw) {
            ctx.beginPath();
            if (s.type === 'rect') ctx.rect(s.start.x, s.start.y, s.end.x-s.start.x, s.end.y-s.start.y);
            else { ctx.moveTo(s.points[0].x, s.points[0].y); s.points.forEach(p=>ctx.lineTo(p.x,p.y)); ctx.closePath(); }
            
            if (confirmed) {
                ctx.strokeStyle = active ? "#FFD700" : "white";
                ctx.lineWidth = active ? lw*2 : lw;
                ctx.fillStyle = active ? "rgba(255,215,0,0.3)" : "rgba(255,255,255,0.05)";
                ctx.fill(); ctx.stroke();
                
                // æ¨™ç±¤
                const fontSize = Math.max(14, 14 / currentScale);
                const center = s.type==='rect'?{x:s.start.x, y:s.start.y}:s.points[0];
                ctx.font = `${fontSize}px sans-serif`;
                const textW = ctx.measureText(s.title).width + 10;
                ctx.fillStyle = active ? "#faad14" : "#28a745";
                ctx.fillRect(center.x, center.y - fontSize*1.5, textW, fontSize*1.4);
                ctx.fillStyle = "#fff";
                ctx.fillText(s.title, center.x+5, center.y - fontSize*0.4);
            } else {
                ctx.strokeStyle = "#ff0055"; ctx.lineWidth = lw; ctx.stroke();
            }
        }

        // --- ç·¨è¼¯åŠŸèƒ½ ---
        function openEditor(shape, index) {
            isEditingNote = false; tempShape = shape; editingShapeIndex = index;
            document.getElementById('modalTitle').innerText = index===-1?"æ–°å¢":"ç·¨è¼¯";
            document.getElementById('titleGroup').classList.remove('hidden');
            inputTitle.value = index===-1 ? ("å€åŸŸ "+(shapes.length+1)) : shape.title;
            inputDesc.value = index===-1 ? "" : shape.desc.replace(/<br>/g, '\n');
            modal.classList.add('show');
            inputTitle.focus();
        }
        function editGlobalNote() {
            isEditingNote = true;
            document.getElementById('modalTitle').innerText = "å°ˆæ¡ˆç­†è¨˜";
            document.getElementById('titleGroup').classList.add('hidden');
            inputDesc.value = globalNote.replace(/<br>/g, '\n');
            modal.classList.add('show');
        }
        function saveModal() {
            const val = inputDesc.value.replace(/\n/g, '<br>');
            if(isEditingNote) globalNote = val;
            else {
                if(!tempShape) return;
                tempShape.title = inputTitle.value || "æœªå‘½å";
                tempShape.desc = val;
                if(editingShapeIndex === -1) { shapes.push(tempShape); focusedShapeIndex = shapes.length-1; }
                else { shapes[editingShapeIndex] = tempShape; focusedShapeIndex = editingShapeIndex; }
            }
            modal.classList.remove('show'); renderLayers(); redraw();
        }
        function cancelModal() { modal.classList.remove('show'); redraw(); }
        function deleteShape(idx) { if(confirm("åˆªé™¤?")) { shapes.splice(idx,1); focusedShapeIndex=-1; renderLayers(); redraw(); } }
        function editShape(idx) { openEditor(shapes[idx], idx); }
        function clearAll() { if(confirm("æ¸…ç©º?")) { shapes=[]; globalNote=""; renderLayers(); redraw(); } }

        // --- ä¸‹è¼‰ (ä¿æŒ V13 çš„å¼·å¤§ Viewer) ---
        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length===0) { alert("ç„¡å…§å®¹"); return; }
            const data = { imgData: originalImageDataUrl, shapes: shapes, globalNote: globalNote };
            
            let svg = '', list = '';
            shapes.forEach((s,i) => {
                const id = `r${i}`;
                if(s.type==='rect') {
                    const w = Math.abs(s.end.x-s.start.x), h = Math.abs(s.end.y-s.start.y);
                    const x = Math.min(s.start.x, s.end.x), y = Math.min(s.start.y, s.end.y);
                    svg += `<rect id="s-${id}" x="${x}" y="${y}" width="${w}" height="${h}" class="ia" onclick="act('${id}')"></rect>`;
                } else {
                    const pts = s.points.map(p=>`${p.x},${p.y}`).join(' ');
                    svg += `<polygon id="s-${id}" points="${pts}" class="ia" onclick="act('${id}')"></polygon>`;
                }
                list += `<div class="li" id="l-${id}" onclick="act('${id}')"><b>${s.title}</b><p>${s.desc}</p></div>`;
            });

            const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>å°è¦½</title><style>
            body{margin:0;background:#222;color:#eee;font-family:sans-serif;height:100vh;display:flex;overflow:hidden;}
            .main{flex:3;position:relative;background:#111;overflow:hidden;display:flex;align-items:center;justify-content:center;}
            .stage{position:relative;transition:transform 0.3s ease-out;transform-origin:center;}
            img{display:block;max-width:none;} .ol{position:absolute;top:0;left:0;width:100%;height:100%;}
            .sidebar{flex:1;min-width:300px;max-width:400px;background:#333;display:flex;flex-direction:column;border-left:1px solid #444;z-index:2;}
            .head{padding:15px;background:#444;display:flex;justify-content:space-between;align-items:center;}
            .list{flex:1;overflow-y:auto;padding:10px;}
            .li{background:#444;margin-bottom:10px;padding:15px;border-radius:5px;cursor:pointer;border-left:4px solid transparent;}
            .li:hover{background:#555;} .li.active{border-left-color:#28a745;background:#555;}
            .li p{max-height:0;overflow:hidden;margin:0;opacity:0;transition:0.3s;color:#ccc;font-size:0.9em;}
            .li.active p{max-height:500px;opacity:1;margin-top:10px;padding-top:10px;border-top:1px solid #666;}
            .ia{fill:rgba(255,255,255,0);stroke:rgba(255,255,255,0.5);stroke-width:2;cursor:pointer;transition:0.2s;}
            .ia:hover{fill:rgba(40,167,69,0.2);stroke:#28a745;} 
            .ia.active{fill:rgba(40,167,69,0.3);stroke:#28a745;stroke-width:4;animation:p 2s infinite;}
            @keyframes p{0%{stroke-opacity:1}50%{stroke-opacity:0.5}100%{stroke-opacity:1}}
            .ctrl{position:absolute;bottom:20px;left:20px;display:flex;gap:5px;background:rgba(0,0,0,0.7);padding:5px;border-radius:20px;}
            .btn{background:transparent;border:1px solid #777;color:#fff;padding:2px 10px;border-radius:10px;cursor:pointer;}
            .note{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9;justify-content:center;align-items:center;}
            .nb{background:#333;padding:20px;border-radius:8px;max-width:600px;width:90%;max-height:80vh;overflow:auto;}
            </style></head><body>
            <div class="main" id="m">
                <div class="stage" id="st"><img src="${originalImageDataUrl}"><svg class="ol" viewBox="0 0 ${canvas.width} ${canvas.height}">${svg}</svg></div>
                <div class="ctrl"><button class="btn" onclick="fit()">Fit</button><button class="btn" onclick="zm(0.2)">+</button><button class="btn" onclick="zm(-0.2)">-</button></div>
            </div>
            <div class="sidebar"><div class="head"><b>åˆ—è¡¨</b><button class="btn" onclick="document.getElementById('nt').style.display='flex'">ç­†è¨˜</button></div><div class="list" id="lst">${list}</div></div>
            <div class="note" id="nt" onclick="this.style.display='none'"><div class="nb" onclick="event.stopPropagation()"><h3>ç­†è¨˜</h3><div>${globalNote||'(ç„¡)'}</div></div></div>
            <script id="restore-data" type="application/json">${JSON.stringify(data)}<\/script>
            <script>
            let sc=1, tx=0, ty=0, actId=null; 
            const st=document.getElementById('st'), m=document.getElementById('m');
            function tr(){ st.style.transform=\`translate(\${tx}px,\${ty}px) scale(\${sc})\`; }
            function fit(){ 
                const wr=m.clientWidth/st.clientWidth, hr=m.clientHeight/st.clientHeight; 
                sc=Math.min(wr,hr)*0.95; tx=0; ty=0; tr(); 
            }
            function zm(d){ sc+=d; if(sc<0.1)sc=0.1; tr(); }
            window.onload=()=>{ fit(); };
            function act(id){
                if(actId) { document.getElementById('s-'+actId)?.classList.remove('active'); document.getElementById('l-'+actId)?.classList.remove('active'); }
                if(actId===id){ actId=null; return; }
                actId=id;
                document.getElementById('s-'+id)?.classList.add('active');
                const li=document.getElementById('l-'+id); li?.classList.add('active');
                li?.scrollIntoView({behavior:'smooth',block:'center'});
            }
            <\/script></body></html>`;

            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([html], {type:"text/html"}));
            link.download = (fileNameInput.value||"map_v14") + ".html";
            link.click();
        }
    </script>
</body>
</html>
