<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map ç”Ÿæˆå™¨ V7 (è‡ªå‹•å°èˆªç‰ˆ)</title>
    <style>
        /* --- ç·¨è¼¯å™¨ä»‹é¢æ¨£å¼ (ä¿æŒä¸è®Š) --- */
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: #f4f6f8; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        h1 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        .toolbar { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        button { padding: 8px 18px; border: 1px solid #ddd; background: #fff; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        button.danger { color: #dc3545; border-color: #dc3545; }
        #canvas-wrapper { position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 4px solid white; border-radius: 4px; overflow: hidden; background: #ddd; min-width: 600px; min-height: 400px; }
        canvas { display: block; cursor: crosshair; }

        /* --- ç·¨è¼¯é¢æ¿ --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .editor-modal.show { visibility: visible; opacity: 1; }
        .editor-card { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; transform: scale(0.9); transition: 0.3s; }
        .editor-modal.show .editor-card { transform: scale(1); }
        .editor-card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1em; }
        .textarea-container { position: relative; }
        textarea { width: 100%; height: 160px; padding: 12px; padding-top: 45px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit; line-height: 1.6; box-sizing: border-box; font-size: 1em; }
        textarea:focus { outline: 2px solid #007bff; border-color: transparent; }
        .textarea-toolbar { position: absolute; top: 1px; left: 1px; right: 1px; background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 6px; border-radius: 6px 6px 0 0; display: flex; gap: 8px; align-items: center; }
        .tool-btn { font-size: 0.85em; padding: 4px 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .tool-btn:hover { background: #e2e6ea; border-color: #adb5bd; }
        .tips { font-size: 0.8em; color: #888; margin-left: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;}
    </style>
</head>
<body>

    <h1>Image Map ç”Ÿæˆå™¨ V7</h1>
    <div class="subtitle">é•·æˆªåœ–è‡ªå‹•å°èˆªãƒ»é»æ“Šè‡ªå‹•æ²å‹•å®šä½</div>

    <div class="toolbar">
        <input type="file" id="imgInput" accept="image/*">
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button id="btnRect" class="active" onclick="setTool('rect')">ç•«çŸ©å½¢</button>
        <button id="btnPoly" onclick="setTool('poly')">ç•«å¤šé‚Šå½¢ (é»å…©ä¸‹çµæŸ)</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button onclick="undo()">å¾©åŸ</button>
        <button class="danger" onclick="clearAll()">æ¸…é™¤</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button class="primary" onclick="downloadPresentation()">ğŸ“¥ ä¸‹è¼‰è‡ªå‹•å°èˆª HTML</button>
    </div>

    <div id="canvas-wrapper">
        <canvas id="editorCanvas"></canvas>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-card">
            <h3>ğŸ“ ç·¨è¼¯å€åŸŸè³‡è¨Š</h3>
            <div>
                <label>æ¨™é¡Œ (å°‡é¡¯ç¤ºåœ¨å´é‚Šåˆ—è¡¨)</label>
                <input type="text" id="inputTitle" placeholder="ä¾‹å¦‚ï¼šåŸå§‹ç¢¼æŒ‰éˆ•">
            </div>
            <div>
                <label>è©³ç´°å…§å®¹ (é¡¯ç¤ºåœ¨å´é‚Šèªªæ˜æ¬„)</label>
                <div class="textarea-container">
                    <div class="textarea-toolbar">
                        <button class="tool-btn" onclick="addHighlight()" title="è¢å…‰ç­†">ğŸ–ï¸ é‡é»è¢å…‰ç­†</button>
                        <span class="tips">Enter å¯æ›è¡Œ</span>
                    </div>
                    <textarea id="inputDesc" placeholder="è«‹è¼¸å…¥è©³ç´°èªªæ˜..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="cancelShape()">å–æ¶ˆ</button>
                <button class="primary" onclick="saveShape()">ç¢ºå®šå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        const modal = document.getElementById('editorModal');
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');

        let image = new Image();
        let shapes = []; let currentShape = null; let tempShape = null; 
        let isDrawing = false; let tool = 'rect'; let originalImageDataUrl = "";

        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#666"; ctx.font = "20px sans-serif"; ctx.fillText("è«‹å…ˆä¸Šå‚³åœ–ç‰‡", 340, 250);

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImageDataUrl = event.target.result;
                image.onload = () => {
                    canvas.width = image.width; canvas.height = image.height;
                    shapes = []; currentShape = null; redraw();
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null; redraw();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect') { isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos }; } 
            else if (tool === 'poly') { if (!currentShape) currentShape = { type: 'poly', points: [pos] }; else currentShape.points.push(pos); }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) { currentShape.end = pos; redraw(); } 
            else if (tool === 'poly' && currentShape) {
                redraw(); ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 10) openEditor(currentShape);
                currentShape = null; redraw();
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                openEditor(currentShape); currentShape = null; redraw();
            }
        });

        function openEditor(shapeData) {
            tempShape = shapeData;
            inputTitle.value = "å€åŸŸ " + (shapes.length + 1);
            inputDesc.value = ""; 
            modal.classList.add('show');
            inputTitle.focus();
        }

        function cancelShape() { tempShape = null; modal.classList.remove('show'); redraw(); }

        function saveShape() {
            if(!tempShape) return;
            let rawDesc = inputDesc.value;
            let formattedDesc = rawDesc.replace(/\n/g, '<br>'); 
            tempShape.title = inputTitle.value || "æœªå‘½å";
            tempShape.desc = formattedDesc;
            shapes.push(tempShape);
            tempShape = null;
            modal.classList.remove('show');
            redraw();
        }
        
        function addHighlight() {
            const textarea = inputDesc;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            if (start === end) { alert("è«‹å…ˆé¸å–æ–‡å­—ï¼"); return; }
            const selected = text.substring(start, end);
            const before = text.substring(0, start);
            const after = text.substring(end);
            const newText = before + `<span class="highlight-text">${selected}</span>` + after;
            textarea.value = newText;
            textarea.focus();
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            shapes.forEach(s => drawShape(s, true));
            if (currentShape && tool === 'rect') drawShape(currentShape, false);
            if (currentShape && tool === 'poly') {
                ctx.beginPath();
                ctx.moveTo(currentShape.points[0].x, currentShape.points[0].y);
                for(let p of currentShape.points) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function drawShape(s, isConfirmed) {
            ctx.beginPath();
            if (s.type === 'rect') {
                const w = s.end.x - s.start.x; const h = s.end.y - s.start.y;
                ctx.rect(s.start.x, s.start.y, w, h);
            } else {
                ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let p of s.points) ctx.lineTo(p.x, p.y); ctx.closePath();
            }
            if(isConfirmed) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.05)"; ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
                let center = s.type === 'rect' ? {x:s.start.x, y:s.start.y} : s.points[0];
                ctx.font = "14px sans-serif";
                const textMetrics = ctx.measureText(s.title);
                const badgeWidth = textMetrics.width + 12;
                ctx.fillStyle = "#28a745"; ctx.beginPath(); ctx.roundRect(center.x, center.y - 26, badgeWidth, 24, 4); ctx.fill();
                ctx.fillStyle = "white"; ctx.fillText(s.title, center.x + 6, center.y - 8);
            } else {
                ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function undo() { shapes.pop(); redraw(); }
        function clearAll() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { shapes = []; redraw(); } }

        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length === 0) { alert("è«‹å…ˆç¹ªè£½ï¼"); return; }

            let svgContent = '';
            let listItems = '';

            shapes.forEach((s, index) => {
                const safeDesc = s.desc.replace(/"/g, '&quot;');
                const id = `region-${index}`;
                
                // SVG Part
                if(s.type === 'rect') {
                    const w = Math.abs(s.end.x - s.start.x); const h = Math.abs(s.end.y - s.start.y);
                    const x = Math.min(s.start.x, s.end.x); const y = Math.min(s.start.y, s.end.y);
                    svgContent += `<rect id="svg-${id}" x="${x}" y="${y}" width="${w}" height="${h}" class="interactive-area" data-id="${id}" data-title="${s.title}" data-desc="${safeDesc}"></rect>`;
                } else {
                    const points = s.points.map(p => `${p.x},${p.y}`).join(' ');
                    svgContent += `<polygon id="svg-${id}" points="${points}" class="interactive-area" data-id="${id}" data-title="${s.title}" data-desc="${safeDesc}"></polygon>`;
                }

                // Sidebar List Part
                listItems += `
                <div class="list-item" id="list-${id}" onclick="activateRegion('${id}')">
                    <div class="item-title">${s.title}</div>
                    <div class="item-desc">${s.desc}</div>
                </div>`;
            });

            const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨“ç·´è³‡è¨Šå„€è¡¨æ¿</title>
    <style>
        body { margin:0; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .layout-container { display: flex; width: 100%; height: 100%; }
        
        /* å·¦å´ï¼šåœ°åœ–å€ (é‡é»ä¿®æ”¹ï¼šoverflow: auto è®“é•·åœ–å¯ä»¥æ²å‹•) */
        .map-section { 
            flex: 3; position: relative; background: #222; 
            overflow: auto; /* å…è¨±å·è»¸ */
            display: flex; justify-content: flex-start; align-items: flex-start; /* é å·¦ä¸Šå°é½Š */
            border-right: 1px solid #333; 
            scroll-behavior: smooth; /* å¹³æ»‘æ²å‹• */
        }
        
        /* åœ–ç‰‡å®¹å™¨ */
        .stage { 
            position: relative; margin: 0 auto;
            transform-origin: center top; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            width: 100%; /* é è¨­æ’æ»¿å®¹å™¨å¯¬åº¦ï¼Œè®“é•·åœ–è‡ªç„¶å‘ä¸‹å»¶ä¼¸ */
            transition: width 0.3s ease;
        }
        
        img { display: block; width: 100%; height: auto; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* å³å´ï¼šå´é‚Šæ¬„ */
        .sidebar { flex: 1; min-width: 300px; max-width: 400px; background: #2b2b2b; color: #fff; display: flex; flex-direction: column; overflow: hidden; z-index: 20;}
        .sidebar-header { padding: 20px; background: #333; border-bottom: 1px solid #444; font-size: 1.2em; font-weight: bold; color: #28a745; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        
        .list-item { background: #383838; margin-bottom: 15px; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; overflow: hidden; }
        .list-item:hover { background: #444; }
        .list-item.active { background: #444; border-left-color: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.2); }
        .item-title { padding: 15px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .item-title::after { content: '+'; color: #888; }
        .list-item.active .item-title::after { content: 'âˆ’'; color: #fff; }
        .item-desc { padding: 0 15px; max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s; color: #ddd; line-height: 1.6; font-size: 0.95em; border-top: 1px solid rgba(255,255,255,0.05); }
        .list-item.active .item-desc { padding: 15px; max-height: 800px; opacity: 1; }

        .interactive-area { fill: rgba(255,255,255,0); stroke: rgba(255,255,255,0.3); stroke-width: 2; transition: all 0.2s; cursor: pointer; }
        .interactive-area:hover { stroke: #28a745; stroke-width: 3; fill: rgba(40,167,69,0.1); }
        .interactive-area.active { stroke: #28a745; stroke-width: 5; fill: rgba(40,167,69,0.25); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.5; } 100% { stroke-opacity: 1; } }
        .highlight-text { background-color: #ffeb3b; color: #000; padding: 2px 4px; border-radius: 3px; font-weight: bold; }

        /* ç¸®æ”¾å·¥å…·åˆ— */
        .zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 100; position: fixed; }
        .zoom-btn { background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .zoom-btn:hover { background: #28a745; border-color: #28a745; }

        @media (max-width: 768px) {
            .layout-container { flex-direction: column; }
            .map-section { flex: 1; min-height: 40vh; }
            .sidebar { flex: 1; min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <div class="map-section" id="mapSection">
            <div class="stage" id="stage">
                <img src="${originalImageDataUrl}">
                <svg class="overlay" viewBox="0 0 ${canvas.width} ${canvas.height}">
                    ${svgContent}
                </svg>
            </div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="setZoom(100)">100%</button>
                <button class="zoom-btn" onclick="setZoom('fit')">Fit</button>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">-</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                ğŸ“ å€åŸŸèªªæ˜å°è¦½
            </div>
            <div class="sidebar-content" id="sidebarList">
                ${listItems}
            </div>
        </div>
    </div>

    <script>
        const mapSection = document.getElementById('mapSection');
        const stage = document.getElementById('stage');
        let currentWidthPercent = 100; // é è¨­ 100% å¯¬åº¦ï¼Œé©åˆé•·åœ–

        function updateZoom() {
            stage.style.width = currentWidthPercent + '%';
        }
        function zoomIn() { currentWidthPercent += 20; updateZoom(); }
        function zoomOut() { if(currentWidthPercent > 40) currentWidthPercent -= 20; updateZoom(); }
        function setZoom(mode) {
            if(mode === 'fit') currentWidthPercent = 95; // ç•¥å°æ–¼ 100 ç¢ºä¿é‚Šç•Œ
            else currentWidthPercent = 100;
            updateZoom();
        }

        let currentActiveId = null;

        function activateRegion(id) {
            // 1. æ¸…é™¤èˆŠç‹€æ…‹
            if(currentActiveId) {
                document.getElementById('svg-' + currentActiveId)?.classList.remove('active');
                document.getElementById('list-' + currentActiveId)?.classList.remove('active');
            }
            
            // 2. è™•ç†åˆ‡æ› (å¦‚æœæ˜¯åŒä¸€å€‹å°±é—œé–‰)
            if(currentActiveId === id) {
                currentActiveId = null;
                return;
            }

            // 3. æ¿€æ´»æ–°ç‹€æ…‹
            currentActiveId = id;
            const svgEl = document.getElementById('svg-' + id);
            const listEl = document.getElementById('list-' + id);
            
            svgEl?.classList.add('active');
            listEl?.classList.add('active');
            listEl?.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // --- æ ¸å¿ƒæ”¹å‹•ï¼šè‡ªå‹•æ²å‹•åˆ°åœ–ç‰‡å°æ‡‰ä½ç½® (Jump to Region) ---
            if(svgEl) {
                // ä½¿ç”¨ scrollIntoView è®“ SVG å…ƒç´ è‡ªå‹•é€²å…¥è¦–é‡ä¸­å¿ƒ
                svgEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            }
        }

        // ç¶å®š SVG é»æ“Š
        document.querySelectorAll('.interactive-area').forEach(area => {
            area.addEventListener('click', (e) => {
                e.stopPropagation();
                activateRegion(area.getAttribute('data-id'));
            });
        });

        // é»æ“Šç©ºç™½è™•
        mapSection.addEventListener('click', (e) => {
            if(e.target === mapSection || e.target === stage || e.target.tagName === 'IMG') {
                 if(currentActiveId) {
                    document.getElementById('svg-' + currentActiveId)?.classList.remove('active');
                    document.getElementById('list-' + currentActiveId)?.classList.remove('active');
                    currentActiveId = null;
                }
            }
        });

    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "dashboard_v7_autoscroll.html";
            link.click();
        }
    </script>
</body>
</html>
