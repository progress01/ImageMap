<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map ç”Ÿæˆå™¨ V11 (å¯æ”¶æŠ˜æ¸…å–®ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: #f4f6f8; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; height: 100vh; box-sizing: border-box; }
        h1 { color: #333; margin-bottom: 5px; margin-top: 0; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        
        /* --- æ§åˆ¶åˆ—èˆ‡å·¥å…·åˆ— --- */
        .top-bar { display: flex; flex-direction: column; align-items: center; width: 100%; flex-shrink: 0; }
        .main-controls { display: flex; gap: 15px; margin-bottom: 10px; }
        .file-group, .toolbar { background: white; padding: 8px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .toolbar { margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        
        button { padding: 6px 15px; border: 1px solid #ddd; background: #fff; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        button.danger { color: #dc3545; border-color: #dc3545; }
        button.info { color: #17a2b8; border-color: #17a2b8; }
        button.note { color: #6610f2; border-color: #6610f2; }
        
        /* åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        button.toggle-sidebar { background: #343a40; color: white; border-color: #343a40; }
        button.toggle-sidebar.off { background: #fff; color: #333; border-color: #ddd; }

        input[type="text"].filename-input { padding: 6px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; width: 160px; text-align: center; }
        input[type="text"].filename-input:focus { border-color: #28a745; }

        /* --- ç·¨è¼¯å€ä½ˆå±€ (å·¦å³æ¬„) --- */
        .workspace { display: flex; width: 100%; max-width: 1200px; height: 100%; overflow: hidden; align-items: flex-start; position: relative; }

        /* å·¦å´ç•«å¸ƒå€ */
        #canvas-wrapper { 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border: 4px solid white; 
            border-radius: 4px; 
            overflow: auto; 
            background: #ddd; 
            flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            max-height: 100%;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease; /* å¹³æ»‘éæ¸¡ */
        }
        canvas { display: block; cursor: crosshair; }

        /* å³å´åœ–å±¤æ¸…å–®å€ */
        .sidebar-panel {
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 600px; 
            border: 1px solid #eee;
            flex-shrink: 0;
            margin-left: 20px; /* ä½¿ç”¨ margin å–ä»£ gap ä»¥ä¾¿æ–¼éš±è— */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; /* éš±è—å…§å®¹ */
            opacity: 1;
        }

        /* éš±è—ç‹€æ…‹ */
        .sidebar-panel.collapsed {
            width: 0;
            margin-left: 0;
            opacity: 0;
            padding: 0;
            border: none;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fcfcfc;
            border-radius: 12px 12px 0 0;
            display: flex; justify-content: space-between; align-items: center;
            white-space: nowrap; /* é˜²æ­¢ç¸®å°æ™‚æ–‡å­—æ›è¡Œ */
        }
        .panel-header h3 { margin: 0; font-size: 1rem; color: #444; }
        
        .header-controls { display: flex; align-items: center; gap: 8px; }
        .close-sidebar-btn { cursor: pointer; color: #999; font-size: 1.2em; line-height: 1; padding: 2px; }
        .close-sidebar-btn:hover { color: #dc3545; }

        .count-badge { background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }

        .layer-list { flex: 1; overflow-y: auto; padding: 10px; min-width: 260px; /* é˜²æ­¢å…§å®¹æ“ å£“ */ }
        
        .layer-item {
            background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 5px; border-left: 3px solid transparent;
        }
        .layer-item:hover { background: #f8f9fa; border-color: #ddd; }
        .layer-item.active { background: #fffbe6; border-color: #ffe58f; border-left-color: #faad14; box-shadow: 0 2px 8px rgba(250, 173, 20, 0.15); }
        
        .layer-top { display: flex; justify-content: space-between; align-items: center; }
        .layer-title { font-weight: bold; font-size: 0.95em; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;}
        .layer-type { font-size: 0.75em; color: #999; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        .layer-actions { display: flex; gap: 5px; justify-content: flex-end; margin-top: 5px; opacity: 0.4; transition: 0.2s; }
        .layer-item:hover .layer-actions, .layer-item.active .layer-actions { opacity: 1; }
        
        .mini-btn { padding: 3px 8px; font-size: 0.8em; height: auto; border-radius: 4px; }
        .mini-btn.edit { color: #007bff; border-color: #007bff; }
        .mini-btn.del { color: #dc3545; border-color: #dc3545; }
        .mini-btn:hover { background: currentColor; color: white; }

        .empty-state { text-align: center; color: #999; padding: 30px 10px; font-size: 0.9em; }

        /* --- ç·¨è¼¯é¢æ¿ (Modal) --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .editor-modal.show { visibility: visible; opacity: 1; }
        .editor-card { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; transform: scale(0.9); transition: 0.3s; }
        .editor-modal.show .editor-card { transform: scale(1); }
        .editor-card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }
        
        .form-group { margin-bottom: 10px; }
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1em; }
        
        .textarea-container { position: relative; }
        textarea { width: 100%; height: 160px; padding: 12px; padding-top: 45px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit; line-height: 1.6; box-sizing: border-box; font-size: 1em; }
        .textarea-toolbar { position: absolute; top: 1px; left: 1px; right: 1px; background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 6px; border-radius: 6px 6px 0 0; display: flex; gap: 8px; align-items: center; }
        .tool-btn { font-size: 0.85em; padding: 4px 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .tips { font-size: 0.8em; color: #888; margin-left: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>Image Map ç”Ÿæˆå™¨ V11</h1>
        <div class="subtitle">è‡ªå‹•å°èˆªãƒ»å°ˆæ¡ˆç­†è¨˜ãƒ»å…¨é¡¯é–‹é—œãƒ»å¯æŠ˜ç–Šæ¸…å–®</div>

        <div class="main-controls">
            <div class="file-group">
                <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 1: æ–°å¢/é‚„åŸ</span>
                <button onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</button>
                <input type="file" id="imgInput" accept="image/*" style="display:none">
                <div style="border-left:1px solid #ddd; height:20px;"></div>
                <button class="info" onclick="document.getElementById('importInput').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
                <input type="file" id="importInput" accept=".html" style="display:none">
            </div>
        </div>

        <div class="toolbar">
            <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 2: ç·¨è¼¯</span>
            <button id="btnRect" class="active" onclick="setTool('rect')">ç•«çŸ©å½¢</button>
            <button id="btnPoly" onclick="setTool('poly')">ç•«å¤šé‚Šå½¢</button>
            <button class="note" onclick="editGlobalNote()">ğŸ“ å°ˆæ¡ˆç­†è¨˜</button>
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <button id="btnToggleSidebar" class="toggle-sidebar" onclick="toggleSidebar()">ğŸ—‚ï¸ éš±è—æ¸…å–®</button>
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <button class="danger" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨</button>
            
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 3: ä¸‹è¼‰</span>
            <input type="text" id="fileNameInput" class="filename-input" placeholder="æª”æ¡ˆåç¨±">
            <button class="primary" onclick="downloadPresentation()">ğŸ“¥ ä¸‹è¼‰ HTML</button>
        </div>
    </div>

    <div class="workspace">
        <div id="canvas-wrapper">
            <canvas id="editorCanvas"></canvas>
        </div>

        <div class="sidebar-panel" id="sidebarPanel">
            <div class="panel-header">
                <h3>å·²å»ºç«‹é …ç›®</h3>
                <div class="header-controls">
                    <span class="count-badge" id="shapeCount">0</span>
                    <span class="close-sidebar-btn" onclick="toggleSidebar()" title="æ”¶èµ·æ¸…å–®">&times;</span>
                </div>
            </div>
            <div class="layer-list" id="layerList">
                <div class="empty-state">å°šç„¡é …ç›®<br>è«‹åœ¨åœ–ç‰‡ä¸Šç¹ªè£½å€åŸŸ</div>
            </div>
        </div>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-card">
            <h3 id="modalTitle">ğŸ“ ç·¨è¼¯å€åŸŸè³‡è¨Š</h3>
            
            <div id="titleGroup" class="form-group">
                <label>æ¨™é¡Œ (å°‡é¡¯ç¤ºåœ¨å´é‚Šåˆ—è¡¨)</label>
                <input type="text" id="inputTitle" placeholder="ä¾‹å¦‚ï¼šåŸå§‹ç¢¼æŒ‰éˆ•">
            </div>
            
            <div class="form-group">
                <label id="descLabel">è©³ç´°å…§å®¹</label>
                <div class="textarea-container">
                    <div class="textarea-toolbar">
                        <button class="tool-btn" onclick="addHighlight()" title="è¢å…‰ç­†">ğŸ–ï¸ é‡é»è¢å…‰ç­†</button>
                        <span class="tips">Enter å¯æ›è¡Œ</span>
                    </div>
                    <textarea id="inputDesc" placeholder="è«‹è¼¸å…¥è©³ç´°èªªæ˜..."></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="cancelModal()">å–æ¶ˆ</button>
                <button class="primary" onclick="saveModal()">ç¢ºå®šå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        const importInput = document.getElementById('importInput');
        const modal = document.getElementById('editorModal');
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');
        const fileNameInput = document.getElementById('fileNameInput');
        const layerListEl = document.getElementById('layerList');
        const shapeCountEl = document.getElementById('shapeCount');
        
        // æ–°å¢ï¼šå´é‚Šæ¬„ç›¸é—œ DOM
        const sidebarPanel = document.getElementById('sidebarPanel');
        const btnToggleSidebar = document.getElementById('btnToggleSidebar');

        let image = new Image();
        let shapes = []; 
        let currentShape = null; 
        let tempShape = null; 
        
        let isDrawing = false; 
        let tool = 'rect'; 
        let originalImageDataUrl = "";
        let globalNote = ""; 
        let isEditingNote = false;
        
        let focusedShapeIndex = -1;
        let editingShapeIndex = -1;

        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#666"; ctx.font = "20px sans-serif"; ctx.fillText("è«‹ä¸Šå‚³åœ–ç‰‡ æˆ– åŒ¯å…¥èˆŠæª”", 300, 250);

        // --- å´é‚Šæ¬„é–‹é—œåŠŸèƒ½ ---
        function toggleSidebar() {
            sidebarPanel.classList.toggle('collapsed');
            
            if (sidebarPanel.classList.contains('collapsed')) {
                btnToggleSidebar.innerHTML = "ğŸ—‚ï¸ é¡¯ç¤ºæ¸…å–®";
                btnToggleSidebar.classList.add('off');
            } else {
                btnToggleSidebar.innerHTML = "ğŸ—‚ï¸ éš±è—æ¸…å–®";
                btnToggleSidebar.classList.remove('off');
            }
        }

        // --- åœ–ç‰‡èˆ‡åŒ¯å…¥ ---
        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result);
                shapes = []; globalNote = ""; 
                fileNameInput.value = file.name.split('.')[0];
                renderLayers(); 
            };
            reader.readAsDataURL(file);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const htmlContent = event.target.result;
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const restoreScript = doc.getElementById('restore-data');
                
                if (restoreScript) {
                    try {
                        const data = JSON.parse(restoreScript.textContent);
                        shapes = data.shapes;
                        globalNote = data.globalNote || "";
                        loadImage(data.imgData);
                        fileNameInput.value = file.name.split('.')[0];
                        renderLayers(); 
                        alert("å°ˆæ¡ˆå·²æˆåŠŸé‚„åŸï¼");
                    } catch (err) { alert("é‚„åŸå¤±æ•—ï¼šæ•¸æ“šæ ¼å¼éŒ¯èª¤ã€‚"); }
                } else { alert("ç„¡æ³•é‚„åŸï¼šæ­¤æª”æ¡ˆå¯èƒ½ä¸æ˜¯ç”±æ­¤ç‰ˆæœ¬ç”¢ç”Ÿã€‚"); }
            };
            reader.readAsText(file);
            importInput.value = '';
        });

        function loadImage(src) {
            originalImageDataUrl = src;
            image.onload = () => {
                canvas.width = image.width; canvas.height = image.height;
                redraw();
            };
            image.src = src;
        }

        // --- ç¹ªåœ–å·¥å…· ---
        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null; redraw();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            
            if(focusedShapeIndex !== -1 && !isDrawing) {
                focusedShapeIndex = -1;
                renderLayers();
                redraw();
            }

            if (tool === 'rect') { isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos }; } 
            else if (tool === 'poly') { if (!currentShape) currentShape = { type: 'poly', points: [pos] }; else currentShape.points.push(pos); }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) { currentShape.end = pos; redraw(); } 
            else if (tool === 'poly' && currentShape) {
                redraw(); ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 10) openEditor(currentShape, -1);
                currentShape = null; redraw();
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                openEditor(currentShape, -1); currentShape = null; redraw();
            }
        });

        // --- ç·¨è¼¯è¦–çª—é‚è¼¯ ---
        function openEditor(shapeData, index) {
            isEditingNote = false;
            tempShape = shapeData;
            editingShapeIndex = index;
            
            document.getElementById('modalTitle').innerText = index === -1 ? "ğŸ“ å»ºç«‹æ–°å€åŸŸ" : "âœï¸ ç·¨è¼¯å€åŸŸè³‡è¨Š";
            document.getElementById('titleGroup').classList.remove('hidden');
            document.getElementById('descLabel').innerText = "è©³ç´°å…§å®¹";
            
            inputTitle.value = index === -1 ? ("å€åŸŸ " + (shapes.length + 1)) : shapeData.title;
            inputDesc.value = index === -1 ? "" : shapeData.desc.replace(/<br>/g, '\n'); 
            
            modal.classList.add('show');
            inputTitle.focus();
        }

        function editGlobalNote() {
            isEditingNote = true;
            document.getElementById('modalTitle').innerText = "ğŸ“‹ ç·¨è¼¯å°ˆæ¡ˆç­†è¨˜ (å‰è¨€/ç¸½çµ)";
            document.getElementById('titleGroup').classList.add('hidden');
            document.getElementById('descLabel').innerText = "ç­†è¨˜å…§å®¹ (æ”¯æ´æ›è¡Œ)";
            inputDesc.value = globalNote.replace(/<br>/g, '\n');
            modal.classList.add('show');
            inputDesc.focus();
        }

        function cancelModal() { 
            tempShape = null; editingShapeIndex = -1;
            modal.classList.remove('show'); 
            redraw(); 
        }

        function saveModal() {
            let formattedDesc = inputDesc.value.replace(/\n/g, '<br>');
            
            if (isEditingNote) {
                globalNote = formattedDesc;
            } else {
                if(!tempShape) return;
                tempShape.title = inputTitle.value || "æœªå‘½å";
                tempShape.desc = formattedDesc;
                
                if(editingShapeIndex === -1) {
                    shapes.push(tempShape);
                    focusedShapeIndex = shapes.length - 1; 
                } else {
                    shapes[editingShapeIndex] = tempShape;
                    focusedShapeIndex = editingShapeIndex;
                }
                tempShape = null;
                editingShapeIndex = -1;
            }
            
            modal.classList.remove('show');
            renderLayers(); 
            // å¦‚æœæ¸…å–®è¢«éš±è—äº†ï¼Œæ–°å¢æ™‚è‡ªå‹•æ‰“é–‹æç¤ºä½¿ç”¨è€…
            if(sidebarPanel.classList.contains('collapsed') && !isEditingNote) {
                toggleSidebar(); 
            }
            redraw();
        }
        
        function addHighlight() {
            const textarea = inputDesc;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            if (start === end) { alert("è«‹å…ˆé¸å–æ–‡å­—ï¼"); return; }
            const text = textarea.value;
            const newText = text.substring(0, start) + `<span class="highlight-text">${text.substring(start, end)}</span>` + text.substring(end);
            textarea.value = newText;
            textarea.focus();
        }

        // --- æ ¸å¿ƒï¼šæ¸²æŸ“åœ–å±¤æ¸…å–®èˆ‡äº’å‹• ---
        function renderLayers() {
            layerListEl.innerHTML = '';
            shapeCountEl.innerText = shapes.length;

            if (shapes.length === 0) {
                layerListEl.innerHTML = '<div class="empty-state">å°šç„¡é …ç›®<br>è«‹åœ¨åœ–ç‰‡ä¸Šç¹ªè£½å€åŸŸ</div>';
                return;
            }

            shapes.forEach((s, idx) => {
                const item = document.createElement('div');
                item.className = `layer-item ${idx === focusedShapeIndex ? 'active' : ''}`;
                item.onclick = () => focusShape(idx);

                const typeLabel = s.type === 'rect' ? 'çŸ©å½¢' : 'å¤šé‚Šå½¢';
                
                item.innerHTML = `
                    <div class="layer-top">
                        <div class="layer-title">${s.title}</div>
                        <div class="layer-type">${typeLabel}</div>
                    </div>
                    <div class="layer-actions">
                        <button class="mini-btn edit" onclick="event.stopPropagation(); editShape(${idx})">âœï¸</button>
                        <button class="mini-btn del" onclick="event.stopPropagation(); deleteShape(${idx})">ğŸ—‘ï¸</button>
                    </div>
                `;
                layerListEl.appendChild(item);
            });
        }

        function focusShape(index) {
            focusedShapeIndex = index;
            renderLayers(); 
            redraw(); 
        }

        function deleteShape(index) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹å€åŸŸå—ï¼Ÿ')) {
                shapes.splice(index, 1);
                focusedShapeIndex = -1;
                renderLayers();
                redraw();
            }
        }

        function editShape(index) {
            openEditor(shapes[index], index);
        }

        function clearAll() { 
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å€åŸŸèˆ‡ç­†è¨˜ï¼Ÿ")) { 
                shapes = []; globalNote=""; focusedShapeIndex = -1;
                renderLayers(); redraw(); 
            } 
        }

        // --- ç¹ªåœ–é‚è¼¯ ---
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            shapes.forEach((s, idx) => {
                const isFocused = (idx === focusedShapeIndex);
                drawShape(s, true, isFocused);
            });
            
            if (currentShape && tool === 'rect') drawShape(currentShape, false, false);
            if (currentShape && tool === 'poly') {
                ctx.beginPath();
                ctx.moveTo(currentShape.points[0].x, currentShape.points[0].y);
                for(let p of currentShape.points) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function drawShape(s, isConfirmed, isFocused) {
            ctx.beginPath();
            if (s.type === 'rect') {
                const w = s.end.x - s.start.x; const h = s.end.y - s.start.y;
                ctx.rect(s.start.x, s.start.y, w, h);
            } else {
                ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let p of s.points) ctx.lineTo(p.x, p.y); ctx.closePath();
            }
            
            if(isConfirmed) {
                if (isFocused) {
                    ctx.fillStyle = "rgba(255, 215, 0, 0.3)"; 
                    ctx.strokeStyle = "#FFD700"; 
                    ctx.lineWidth = 4;
                } else {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.05)"; 
                    ctx.strokeStyle = "#fff"; 
                    ctx.lineWidth = 2;
                }
                ctx.fill(); ctx.stroke();

                let center = s.type === 'rect' ? {x:s.start.x, y:s.start.y} : s.points[0];
                ctx.font = "14px sans-serif";
                const textMetrics = ctx.measureText(s.title);
                const badgeWidth = textMetrics.width + 12;
                
                ctx.fillStyle = isFocused ? "#faad14" : "#28a745"; 
                ctx.beginPath(); ctx.roundRect(center.x, center.y - 26, badgeWidth, 24, 4); ctx.fill();
                ctx.fillStyle = isFocused ? "#000" : "white"; 
                ctx.fillText(s.title, center.x + 6, center.y - 8);
            } else {
                ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        // --- ä¸‹è¼‰ç”Ÿæˆ HTML ---
        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length === 0) { alert("è«‹å…ˆç¹ªè£½ï¼"); return; }
            const restoreData = { imgData: originalImageDataUrl, shapes: shapes, globalNote: globalNote };
            const safeNote = globalNote ? globalNote : "ï¼ˆæ­¤å°ˆæ¡ˆå°šç„¡ç­†è¨˜ï¼‰";
            
            let svgContent = ''; let listItems = '';
            shapes.forEach((s, index) => {
                const safeDesc = s.desc.replace(/"/g, '&quot;');
                const id = `region-${index}`;
                if(s.type === 'rect') {
                    const w = Math.abs(s.end.x - s.start.x); const h = Math.abs(s.end.y - s.start.y);
                    const x = Math.min(s.start.x, s.end.x); const y = Math.min(s.start.y, s.end.y);
                    svgContent += `<rect id="svg-${id}" x="${x}" y="${y}" width="${w}" height="${h}" class="interactive-area" data-id="${id}" data-title="${s.title}" data-desc="${safeDesc}"></rect>`;
                } else {
                    const points = s.points.map(p => `${p.x},${p.y}`).join(' ');
                    svgContent += `<polygon id="svg-${id}" points="${points}" class="interactive-area" data-id="${id}" data-title="${s.title}" data-desc="${safeDesc}"></polygon>`;
                }
                listItems += `<div class="list-item" id="list-${id}" onclick="activateRegion('${id}')"><div class="item-title">${s.title}</div><div class="item-desc">${s.desc}</div></div>`;
            });

            // Viewer æ¨£ç‰ˆ
            const htmlContent = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>è¨“ç·´è³‡è¨Šå„€è¡¨æ¿</title><style>body { margin:0; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; overflow: hidden; } .layout-container { display: flex; width: 100%; height: 100%; } .map-section { flex: 3; position: relative; background: #222; overflow: auto; display: flex; justify-content: flex-start; align-items: flex-start; border-right: 1px solid #333; scroll-behavior: smooth; } .stage { position: relative; margin: 0 auto; transform-origin: center top; box-shadow: 0 0 50px rgba(0,0,0,0.5); width: 100%; transition: width 0.3s ease; } img { display: block; width: 100%; height: auto; } .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; } .sidebar { flex: 1; min-width: 300px; max-width: 400px; background: #2b2b2b; color: #fff; display: flex; flex-direction: column; overflow: hidden; z-index: 20;} .sidebar-header { padding: 15px 20px; background: #333; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; } .header-title { font-size: 1.1em; font-weight: bold; color: #28a745; display: flex; align-items: center; gap: 8px;} .note-btn { background: #6610f2; color: white; border: none; padding: 5px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85em; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } .note-btn:hover { background: #520dc2; transform: translateY(-1px); } .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; } .list-item { background: #383838; margin-bottom: 15px; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; overflow: hidden; } .list-item:hover { background: #444; } .list-item.active { background: #444; border-left-color: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.2); } .item-title { padding: 15px; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; } .item-title::after { content: '+'; color: #888; } .list-item.active .item-title::after { content: 'âˆ’'; color: #fff; } .item-desc { padding: 0 15px; max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s; color: #ddd; line-height: 1.6; font-size: 0.95em; border-top: 1px solid rgba(255,255,255,0.05); } .list-item.active .item-desc { padding: 15px; max-height: 800px; opacity: 1; } .interactive-area { fill: rgba(255,255,255,0); stroke: rgba(255,255,255,0.3); stroke-width: 2; transition: all 0.2s; cursor: pointer; } .interactive-area:hover { stroke: #28a745; stroke-width: 3; fill: rgba(40,167,69,0.1); } .interactive-area.active { stroke: #28a745; stroke-width: 5; fill: rgba(40,167,69,0.25); animation: pulse 2s infinite; } @keyframes pulse { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.5; } 100% { stroke-opacity: 1; } } .interactive-area.show-all { stroke: #17a2b8 !important; stroke-width: 2 !important; stroke-opacity: 0.8 !important; fill: rgba(23, 162, 184, 0.1) !important; } .interactive-area.active.show-all { stroke: #28a745 !important; stroke-width: 5 !important; fill: rgba(40,167,69,0.25) !important; } .highlight-text { background-color: #ffeb3b; color: #000; padding: 2px 4px; border-radius: 3px; font-weight: bold; } .zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 100; position: fixed; } .zoom-btn { background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; } .zoom-btn:hover { background: #28a745; border-color: #28a745; } .zoom-btn.active { background: #17a2b8; border-color: #17a2b8; box-shadow: 0 0 10px rgba(23, 162, 184, 0.5); } .note-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); } .note-card { background: #2b2b2b; color: #eee; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 12px; padding: 0; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #444; } .note-header { padding: 15px 20px; border-bottom: 1px solid #444; font-size: 1.2em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: #333; border-radius: 12px 12px 0 0;} .note-close { cursor: pointer; color: #aaa; font-size: 1.5em; line-height: 1; } .note-close:hover { color: #fff; } .note-body { padding: 25px; overflow-y: auto; line-height: 1.8; font-size: 1.05em; white-space: pre-wrap; } @media (max-width: 768px) { .layout-container { flex-direction: column; } .map-section { flex: 1; min-height: 40vh; } .sidebar { flex: 1; min-width: 100%; } } </style></head><body><div class="layout-container"><div class="map-section" id="mapSection"><div class="stage" id="stage"><img src="${originalImageDataUrl}"><svg class="overlay" viewBox="0 0 ${canvas.width} ${canvas.height}">${svgContent}</svg></div><div class="zoom-controls"><button class="zoom-btn" onclick="toggleAll(this)" title="é¡¯ç¤ºæ‰€æœ‰æ¨™ç¤ºæ¡†">ğŸ‘ï¸ å…¨é¡¯</button><div style="width:1px; background:#666; height:20px; margin: 0 5px;"></div><button class="zoom-btn" onclick="setZoom(100)">100%</button><button class="zoom-btn" onclick="setZoom('fit')">Fit</button><button class="zoom-btn" onclick="zoomIn()">+</button><button class="zoom-btn" onclick="zoomOut()">-</button></div></div><div class="sidebar"><div class="sidebar-header"><div class="header-title">ğŸ“ å€åŸŸèªªæ˜å°è¦½</div><button class="note-btn" onclick="toggleNote()">ğŸ“‹ é–±è®€ç­†è¨˜</button></div><div class="sidebar-content" id="sidebarList">${listItems}</div></div></div><div class="note-modal" id="noteModal" onclick="toggleNote()"><div class="note-card" onclick="event.stopPropagation()"><div class="note-header"><span>ğŸ“‹ å°ˆæ¡ˆç­†è¨˜ / å‰æƒ…æè¦</span><span class="note-close" onclick="toggleNote()">&times;</span></div><div class="note-body">${safeNote}</div></div></div><script id="restore-data" type="application/json">${JSON.stringify(restoreData)}<\/script><script>const mapSection = document.getElementById('mapSection'); const stage = document.getElementById('stage'); let currentWidthPercent = 100; function updateZoom() { stage.style.width = currentWidthPercent + '%'; } function zoomIn() { currentWidthPercent += 20; updateZoom(); } function zoomOut() { if(currentWidthPercent > 40) currentWidthPercent -= 20; updateZoom(); } function setZoom(mode) { if(mode === 'fit') currentWidthPercent = 95; else currentWidthPercent = 100; updateZoom(); } let currentActiveId = null; function activateRegion(id) { if(currentActiveId) { document.getElementById('svg-' + currentActiveId)?.classList.remove('active'); document.getElementById('list-' + currentActiveId)?.classList.remove('active'); } if(currentActiveId === id) { currentActiveId = null; return; } currentActiveId = id; const svgEl = document.getElementById('svg-' + id); const listEl = document.getElementById('list-' + id); svgEl?.classList.add('active'); listEl?.classList.add('active'); listEl?.scrollIntoView({ behavior: 'smooth', block: 'center' }); svgEl?.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } function toggleAll(btn) { const allAreas = document.querySelectorAll('.interactive-area'); const isActive = btn.classList.toggle('active'); allAreas.forEach(area => { if(isActive) area.classList.add('show-all'); else area.classList.remove('show-all'); }); } function toggleNote() { const modal = document.getElementById('noteModal'); if(modal.style.display === 'flex') modal.style.display = 'none'; else modal.style.display = 'flex'; } document.querySelectorAll('.interactive-area').forEach(area => { area.addEventListener('click', (e) => { e.stopPropagation(); activateRegion(area.getAttribute('data-id')); }); }); mapSection.addEventListener('click', (e) => { if(e.target === mapSection || e.target === stage || e.target.tagName === 'IMG') { if(currentActiveId) { document.getElementById('svg-' + currentActiveId)?.classList.remove('active'); document.getElementById('list-' + currentActiveId)?.classList.remove('active'); currentActiveId = null; } } }); <\/script></body></html>`;

            const blob = new Blob([htmlContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            let rawName = fileNameInput.value.trim();
            if(!rawName) rawName = "dashboard_v11";
            link.download = rawName + ".html";
            link.click();
        }
    </script>
</body>
</html>
