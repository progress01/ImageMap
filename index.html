<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        /* --- 1. æ ¸å¿ƒä½ˆå±€ --- */
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: #f4f6f8; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        h1 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        .main-controls { display: flex; gap: 15px; margin-bottom: 15px; width: 100%; justify-content: center; }
        .file-group { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .toolbar { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; z-index: 10; position: sticky; top: 10px; }
        
        /* --- 2. æŒ‰éˆ•æ¨£å¼ --- */
        button { padding: 8px 18px; border: 1px solid #ddd; background: #fff; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        button.excel { background: #1D6F42; color: white; border-color: #1D6F42; box-shadow: 0 4px 10px rgba(29,111,66,0.3); }
        button.duplicate { color: #fd7e14; border-color: #fd7e14; }
        button.danger { color: #dc3545; border-color: #dc3545; }
        button.info { color: #17a2b8; border-color: #17a2b8; }
        button.note { color: #6610f2; border-color: #6610f2; }
        button.magic { background: #6f42c1; color: white; border-color: #6f42c1; }
        button.settings { background: #343a40; color: white; border-color: #343a40; }
        button.toggle-view { background: #17a2b8; color: white; border-color: #17a2b8; }

        /* --- 3. ç•«å¸ƒå€åŸŸ --- */
        #canvas-wrapper { position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 4px solid white; border-radius: 4px; background: #ddd; min-width: 600px; min-height: 400px; margin-bottom: 50px; }
        canvas { display: block; cursor: crosshair; }
        input[type="text"].filename-input { padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; width: 180px; text-align: center; }
        input[type="text"].filename-input:focus { border-color: #28a745; }

        /* --- 4. æ‡¸æµ®æ¸…å–® (Sidekick) --- */
        .sidekick-panel { position: fixed; right: 20px; top: 100px; width: 240px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #eee; z-index: 100; display: flex; flex-direction: column; max-height: 70vh; transition: 0.3s; }
        .sidekick-panel.minimized { width: 40px; height: 40px; overflow: hidden; border-radius: 50%; top: auto; bottom: 20px; }
        .sidekick-header { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #555; font-size: 0.9em; cursor: move; }
        .sidekick-toggle { cursor: pointer; padding: 0 5px; color: #999; }
        .sidekick-content { flex: 1; overflow-y: auto; padding: 10px; background: #fff; border-radius: 0 0 10px 10px; }
        .sk-item { padding: 8px 10px; border: 1px solid #eee; margin-bottom: 6px; border-radius: 6px; cursor: pointer; font-size: 0.9em; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .sk-item:hover { background: #f4f6f8; }
        .sk-item.active { border-left-color: #28a745; background: #e8f5e9; border-color: #c3e6cb; }
        .sk-actions { display: flex; gap: 4px; }
        .sk-btn { font-size: 0.8em; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        /* --- 5. æ¨™ç±¤ç®¡ç† Modal --- */
        .tag-modal-content { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; }
        .tag-row { display: flex; gap: 8px; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .tag-row:last-child { border-bottom: none; }
        .tag-row input[type="text"] { flex: 1; padding: 6px; }
        .tag-row input[type="color"] { width: 40px; height: 35px; border: none; cursor: pointer; }
        .tag-add-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .system-zone { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; }
        .system-stats { font-size: 0.85em; color: #666; margin-bottom: 10px; }

        /* --- 6. ç·¨è¼¯ Modal --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .editor-modal.show { visibility: visible; opacity: 1; }
        .editor-card { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; transform: scale(0.9); transition: 0.3s; max-height: 90vh; overflow-y: auto; }
        .editor-modal.show .editor-card { transform: scale(1); }
        .editor-card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }
        
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1em; }
        .status-picker { display: flex; gap: 10px; align-items: center; }
        .color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
        .color-opt:hover { transform: scale(1.1); }
        .color-opt.selected { border-color: #333; transform: scale(1.1); }
        
        .quick-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 30px; }
        .tag-chip { font-size: 0.85em; padding: 6px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #eee; transition: 0.2s; display: flex; align-items: center; gap: 5px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tag-chip:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-color: #28a745; }
        .tag-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

        .textarea-container { position: relative; }
        textarea { width: 100%; height: 120px; padding: 12px; padding-top: 45px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit; line-height: 1.6; box-sizing: border-box; font-size: 1em; }
        .textarea-toolbar { position: absolute; top: 1px; left: 1px; right: 1px; background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 6px; border-radius: 6px 6px 0 0; display: flex; gap: 8px; align-items: center; }
        .tool-btn { font-size: 0.85em; padding: 4px 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .tips { font-size: 0.8em; color: #888; margin-left: auto; }
        
        .ref-img-zone { border: 2px dashed #ddd; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        .ref-img-zone:hover { border-color: #007bff; background: #f0f7ff; }
        .ref-img-preview { max-width: 100%; max-height: 150px; border-radius: 4px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ref-actions { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }

        .modal-footer { display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .footer-right { display: flex; gap: 10px; }
        .hidden { display: none; }
        .highlight-text { background-color: #ffeb3b; padding: 0 2px; }
    </style>
</head>
<body>

    <h1>Image Map ç”Ÿæˆå™¨</h1>
    <div class="subtitle">æ”¯æ´æ–‡ä»¶å¯©é–±ã€Excel ç„¡è­¦å‘Šã€æ™ºæ…§æ¨™ç±¤åˆ‡æ›</div>

    <div class="main-controls">
        <div class="file-group">
            <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 1: æ–°å¢æˆ–é‚„åŸ</span>
            <button onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸ ä¸Šå‚³æ–°åœ–ç‰‡</button>
            <input type="file" id="imgInput" accept="image/*" style="display:none">
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <button class="info" onclick="document.getElementById('importInput').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="importInput" accept=".html" style="display:none">
        </div>
    </div>

    <div class="toolbar">
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 2: ç¹ªè£½</span>
        <button id="btnRect" class="active" onclick="setTool('rect')">ç•«çŸ©å½¢</button>
        <button id="btnPoly" onclick="setTool('poly')">ç•«å¤šé‚Šå½¢</button>
        <button class="settings" onclick="openTagManager()">âš™ï¸ è¨­å®šæ¨™ç±¤</button>
        <button id="btnToggleLabel" class="toggle-view" onclick="toggleLabels()">ğŸ‘ï¸ é¡¯ç¤ºå®Œæ•´æ¨™ç±¤</button>
        
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button class="note" onclick="editGlobalNote()">ğŸ“ å°ˆæ¡ˆç­†è¨˜</button>
        <button onclick="undo()" title="å¿«æ·éµ Ctrl+Z">å¾©åŸ</button>
        <button class="danger" onclick="clearAll()">æ¸…é™¤</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 3: åŒ¯å‡º</span>
        <input type="text" id="fileNameInput" class="filename-input" placeholder="æª”æ¡ˆåç¨±">
        <button class="excel" onclick="downloadRealExcel()">ğŸ“Š ä¸‹è¼‰ Excel (.xlsx)</button>
        <button class="primary" onclick="downloadPresentation()">ğŸ“¥ ä¸‹è¼‰ HTML</button>
    </div>

    <div id="canvas-wrapper">
        <canvas id="editorCanvas"></canvas>
    </div>

    <div class="sidekick-panel" id="sidekickPanel">
        <div class="sidekick-header">
            <span id="skTitle">é …ç›®åˆ—è¡¨ (0)</span>
            <span class="sidekick-toggle" onclick="toggleSidekick()" title="æœ€å°åŒ–">â–</span>
        </div>
        <div class="sidekick-content" id="sidekickList">
            <div style="text-align:center; color:#999; font-size:0.8em; margin-top:20px;">ç„¡é …ç›®</div>
        </div>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-card">
            <h3 id="modalTitle">ğŸ“ ç·¨è¼¯å€åŸŸè³‡è¨Š</h3>
            <div id="titleGroup">
                <label>æ¨™é¡Œ</label>
                <input type="text" id="inputTitle" placeholder="ä¾‹å¦‚ï¼šé¦–é  Banner (å¿…å¡«)">
            </div>
            <div id="statusGroup">
                <label>æ¨™ç±¤</label>
                <div class="quick-tags" id="quickTagsArea"></div>
                <div class="status-picker">
                    <input type="text" id="inputStatusText" placeholder="æ¨™ç±¤åç¨±..." style="flex:1;">
                    <div class="color-opt" style="background:#dc3545;" onclick="selectColor('#dc3545')" title="ç´…è‰²"></div>
                    <div class="color-opt" style="background:#ffc107;" onclick="selectColor('#ffc107')" title="é»ƒè‰²"></div>
                    <div class="color-opt" style="background:#28a745;" onclick="selectColor('#28a745')" title="ç¶ è‰²"></div>
                    <div class="color-opt" style="background:#007bff;" onclick="selectColor('#007bff')" title="è—è‰²"></div>
                    <div class="color-opt" style="background:#6c757d;" onclick="selectColor('#6c757d')" title="ç°è‰²"></div>
                </div>
                <input type="hidden" id="inputStatusColor" value="">
            </div>
            <div>
                <label>è©³ç´°å…§å®¹ (æ–‡å­—èªªæ˜)</label>
                <div class="textarea-container">
                    <div class="textarea-toolbar">
                        <button class="tool-btn" onclick="addHighlight()">ğŸ–ï¸ é‡é»</button>
                        <button id="btnGenLegend" class="tool-btn magic hidden" onclick="generateLegendToNote()">âœ¨ ç”¢ç”Ÿåœ–ä¾‹</button>
                    </div>
                    <textarea id="inputDesc" placeholder="è«‹è¼¸å…¥å•é¡Œæè¿°æˆ–éœ€æ±‚èªªæ˜..."></textarea>
                </div>
            </div>
            <div id="refImgGroup">
                <label>åƒè€ƒåœ–ç‰‡ (Mockup / å°ç…§åœ–)</label>
                <div class="ref-img-zone" onclick="document.getElementById('inputRefImg').click()">
                    <span id="refImgPlaceholder" style="color:#888; font-size:0.9em;">â• é»æ“Šä¸Šå‚³åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</span>
                    <input type="file" id="inputRefImg" accept="image/*" style="display:none" onchange="handleRefImg(this)">
                    <div id="refImgPreviewContainer" class="hidden">
                        <img id="refImgPreview" class="ref-img-preview" src="">
                        <div class="ref-actions">
                            <button class="danger" style="font-size:0.8em; padding:2px 8px;" onclick="event.stopPropagation(); removeRefImg()">ç§»é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="duplicateBtnGroup">
                    <button class="duplicate" type="button" onclick="duplicateShape()">ğŸ“‹ åŸåœ°è¤‡è£½</button>
                </div>
                <div class="footer-right">
                    <button onclick="cancelModal()">å–æ¶ˆ</button>
                    <button class="primary" onclick="saveModal()">ç¢ºå®šå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div class="editor-modal" id="tagManagerModal">
        <div class="editor-card">
            <h3>âš™ï¸ æ¨™ç±¤ç®¡ç†ä¸­å¿ƒ</h3>
            <div class="tag-add-box">
                <input type="color" id="newTagColor" value="#dc3545">
                <input type="text" id="newTagName" placeholder="è¼¸å…¥æ–°æ¨™ç±¤åç¨±..." style="flex:1;">
                <button class="primary" style="padding: 6px 15px;" onclick="addPresetTag()">ï¼‹ æ–°å¢</button>
            </div>
            <div class="tag-modal-content" id="presetList"></div>
            <div class="system-zone">
                <div style="font-weight:bold; color:#dc3545; margin-bottom:5px;">âš ï¸ ç³»çµ±ç¶­è­·å€</div>
                <div class="system-stats" id="storageStats">è®€å–ä¸­...</div>
                <button class="danger" style="width:100%;" onclick="resetAllSettings()">â™»ï¸ é‡ç½®æ‰€æœ‰è¨­å®š</button>
            </div>
            <div class="modal-footer"><button onclick="closeTagManager()">é—œé–‰</button></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        const importInput = document.getElementById('importInput');
        
        // UI
        const modal = document.getElementById('editorModal');
        const tagManagerModal = document.getElementById('tagManagerModal');
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');
        const inputStatusText = document.getElementById('inputStatusText');
        const inputStatusColor = document.getElementById('inputStatusColor');
        const quickTagsArea = document.getElementById('quickTagsArea');
        const btnGenLegend = document.getElementById('btnGenLegend');
        const fileNameInput = document.getElementById('fileNameInput');
        const sidekickPanel = document.getElementById('sidekickPanel');
        const sidekickList = document.getElementById('sidekickList');
        const skTitle = document.getElementById('skTitle');
        const duplicateBtnGroup = document.getElementById('duplicateBtnGroup');
        const storageStats = document.getElementById('storageStats');
        const newTagName = document.getElementById('newTagName');
        const newTagColor = document.getElementById('newTagColor');
        const presetList = document.getElementById('presetList');
        const btnToggleLabel = document.getElementById('btnToggleLabel');
        
        const refImgGroup = document.getElementById('refImgGroup');
        const refImgPreview = document.getElementById('refImgPreview');
        const refImgPreviewContainer = document.getElementById('refImgPreviewContainer');
        const refImgPlaceholder = document.getElementById('refImgPlaceholder');

        let focusedShapeIndex = -1;
        let image = new Image();
        let shapes = []; let currentShape = null; let tempShape = null; 
        let isDrawing = false; let tool = 'rect'; let originalImageDataUrl = "";
        let globalNote = ""; let isEditingNote = false; let editingShapeIndex = -1;
        let tagPresets = []; 
        let tempRefImgBase64 = "";
        
        let showFullLabels = false; 
        let lastMousePos = { x: 0, y: 0 };

        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#666"; ctx.font = "20px sans-serif"; ctx.fillText("è«‹ä¸Šå‚³åœ–ç‰‡ (V30 Final)", 300, 250);
        loadPresets();

        // éµç›¤ç›£è½: åˆªé™¤, ESC, Ctrl+Z
        document.addEventListener('keydown', (e) => {
            if (modal.classList.contains('show') || tagManagerModal.classList.contains('show')) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'Delete' && focusedShapeIndex !== -1) {
                deleteShape(focusedShapeIndex);
            }
            if (e.key === 'Escape') {
                if (isDrawing) { isDrawing = false; currentShape = null; redraw(); } 
                else if (focusedShapeIndex !== -1) { focusedShapeIndex = -1; renderSidekick(); redraw(); }
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        // --- File I/O ---
        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => { loadImage(event.target.result); shapes = []; globalNote = ""; fileNameInput.value = file.name.split('.')[0]; renderSidekick(); };
            reader.readAsDataURL(file);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const doc = new DOMParser().parseFromString(event.target.result, 'text/html');
                    const script = doc.getElementById('restore-data');
                    if (script) {
                        const data = JSON.parse(script.textContent);
                        shapes = data.shapes; globalNote = data.globalNote || "";
                        loadImage(data.imgData);
                        fileNameInput.value = file.name.split('.')[0];
                        renderSidekick();
                        alert("å°ˆæ¡ˆå·²é‚„åŸï¼");
                    }
                } catch(e) { alert("è®€å–å¤±æ•—"); }
            };
            reader.readAsText(file);
            importInput.value = '';
        });

        function loadImage(src) {
            originalImageDataUrl = src;
            image.onload = () => { canvas.width = image.width; canvas.height = image.height; redraw(); };
            image.src = src;
        }

        // --- Tag Manager ---
        function loadPresets() {
            const saved = localStorage.getItem('imgMapPresets_v25');
            if(saved) { tagPresets = JSON.parse(saved); } else { tagPresets = [ { name: 'åš´é‡ Bug', color: '#dc3545' }, { name: 'åŠŸèƒ½å„ªåŒ–', color: '#ffc107' }, { name: 'å·²å®Œæˆ', color: '#28a745' } ]; }
        }
        function savePresets() { localStorage.setItem('imgMapPresets_v25', JSON.stringify(tagPresets)); }
        function openTagManager() { renderPresetList(); const size = (new Blob([localStorage.getItem('imgMapPresets_v25') || '']).size / 1024).toFixed(2); storageStats.innerText = `ç›®å‰å„²å­˜äº† ${tagPresets.length} å€‹æ¨™ç±¤ (ä½”ç”¨ç´„ ${size} KB)`; tagManagerModal.classList.add('show'); }
        function closeTagManager() { tagManagerModal.classList.remove('show'); }
        function resetAllSettings() { if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰è¨­å®šï¼Ÿ")) { localStorage.removeItem('imgMapPresets_v25'); loadPresets(); renderPresetList(); openTagManager(); } }
        function renderPresetList() {
            presetList.innerHTML = '';
            if(tagPresets.length === 0) { presetList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">å°šç„¡è¨­å®šæ¨™ç±¤</div>'; return; }
            tagPresets.forEach((tag, idx) => {
                const row = document.createElement('div'); row.className = 'tag-row';
                row.innerHTML = `<div style="width:24px; height:24px; border-radius:50%; background:${tag.color}; border:1px solid #ddd;"></div><span style="flex:1; font-weight:bold;">${tag.name}</span><button class="danger" style="padding:4px 10px; font-size:0.8em;" onclick="deletePreset(${idx})">åˆªé™¤</button>`;
                presetList.appendChild(row);
            });
        }
        function addPresetTag() { const name = newTagName.value.trim(); const color = newTagColor.value; if(!name) return; tagPresets.push({ name, color }); savePresets(); newTagName.value = ''; renderPresetList(); openTagManager(); }
        function deletePreset(idx) { if(confirm("åˆªé™¤æ­¤æ¨™ç±¤ï¼Ÿ")) { tagPresets.splice(idx, 1); savePresets(); renderPresetList(); openTagManager(); } }

        // --- Drawing Logic ---
        function setTool(t) { tool = t; document.getElementById('btnRect').classList.toggle('active', t === 'rect'); document.getElementById('btnPoly').classList.toggle('active', t === 'poly'); currentShape = null; redraw(); }
        function getPos(e) { const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height; return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY }; }
        
        canvas.addEventListener('mousedown', (e) => { 
            if (!image.src) return; 
            if(focusedShapeIndex !== -1 && !isDrawing) { focusedShapeIndex = -1; renderSidekick(); redraw(); } 
            const pos = getPos(e); 
            if (tool === 'rect') { isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos }; } 
            else if (tool === 'poly') { if (!currentShape) currentShape = { type: 'poly', points: [pos] }; else currentShape.points.push(pos); } 
            redraw(); 
        });
        
        canvas.addEventListener('mousemove', (e) => { 
            if (!image.src) return; 
            const pos = getPos(e); 
            lastMousePos = pos; 
            
            if (tool === 'rect' && isDrawing) { currentShape.end = pos; redraw(); } 
            else if (tool === 'poly' && currentShape) { redraw(); ctx.beginPath(); const last = currentShape.points[currentShape.points.length - 1]; ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y); ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke(); } 
            else if (!isDrawing) { redraw(); }
        });
        
        canvas.addEventListener('mouseup', (e) => { if (tool === 'rect' && isDrawing) { isDrawing = false; if(Math.abs(currentShape.start.x - currentShape.end.x) > 10) openEditor(currentShape, -1); currentShape = null; redraw(); } });
        canvas.addEventListener('dblclick', (e) => { if (tool === 'poly' && currentShape && currentShape.points.length > 2) { openEditor(currentShape, -1); currentShape = null; redraw(); } });
        function selectColor(color) { inputStatusColor.value = color; document.querySelectorAll('.color-opt').forEach(el => { el.classList.toggle('selected', el.getAttribute('style').includes(color)); }); }
        
        function renderQuickTags() {
            quickTagsArea.innerHTML = '';
            if(tagPresets.length === 0) { quickTagsArea.innerHTML = '<span style="color:#999; font-size:0.8em; align-self:center;">(ç„¡é è¨­æ¨™ç±¤ï¼Œè«‹é»é¸ä¸Šæ–¹ã€Œâš™ï¸è¨­å®šæ¨™ç±¤ã€æ–°å¢)</span>'; return; }
            tagPresets.forEach(tag => {
                const chip = document.createElement('div'); chip.className = 'tag-chip';
                chip.innerHTML = `<span class="tag-dot" style="background:${tag.color}"></span>${tag.name}`;
                chip.onclick = () => { inputStatusText.value = tag.name; selectColor(tag.color); };
                quickTagsArea.appendChild(chip);
            });
        }

        function handleRefImg(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const maxW = 800;
                        const scale = img.width > maxW ? maxW / img.width : 1;
                        const c = document.createElement('canvas'); c.width = img.width * scale; c.height = img.height * scale;
                        const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, c.width, c.height);
                        tempRefImgBase64 = c.toDataURL('image/jpeg', 0.8);
                        refImgPreview.src = tempRefImgBase64; refImgPreviewContainer.classList.remove('hidden'); refImgPlaceholder.classList.add('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeRefImg() { tempRefImgBase64 = ""; document.getElementById('inputRefImg').value = ""; refImgPreview.src = ""; refImgPreviewContainer.classList.add('hidden'); refImgPlaceholder.classList.remove('hidden'); }

        function generateLegendToNote() {
            const uniqueTags = new Map();
            shapes.forEach(s => { if(s.statusText && s.statusColor) { const key = s.statusText + "|" + s.statusColor; uniqueTags.set(key, { text: s.statusText, color: s.statusColor }); } });
            if(uniqueTags.size === 0) { alert("ç„¡æ¨™ç±¤å¯æå–"); return; }
            let legendHtml = "\n\n<b>ã€åœ–ä¾‹èªªæ˜ã€‘</b><br>";
            uniqueTags.forEach(tag => { legendHtml += `<span style="color:${tag.color}">â—</span> <b>${tag.text}</b><br>`; });
            legendHtml += "<hr>";
            document.getElementById('inputDesc').value += legendHtml;
            alert("å·²ç”¢ç”Ÿåœ–ä¾‹");
        }

        function toggleSidekick() { sidekickPanel.classList.toggle('minimized'); const btn = sidekickPanel.querySelector('.sidekick-toggle'); if(sidekickPanel.classList.contains('minimized')) { btn.innerText = "â•"; skTitle.innerText = ""; } else { btn.innerText = "â–"; renderSidekick(); } }
        function renderSidekick() {
            sidekickList.innerHTML = ''; skTitle.innerText = `é …ç›®åˆ—è¡¨ (${shapes.length})`;
            if(shapes.length === 0) { sidekickList.innerHTML = '<div style="text-align:center; color:#999; font-size:0.8em; margin-top:20px;">ç„¡é …ç›®</div>'; return; }
            shapes.forEach((s, idx) => {
                const item = document.createElement('div'); item.className = `sk-item ${idx === focusedShapeIndex ? 'active' : ''}`;
                item.onclick = () => focusShape(idx);
                const title = s.title || "æœªå‘½å"; const dotHtml = s.statusColor ? `<span class="status-dot" style="background:${s.statusColor}"></span>` : '';
                item.innerHTML = `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:120px; font-weight:bold; display:flex; align-items:center;"><span style="color:#999; font-size:0.8em; margin-right:5px;">${idx+1}.</span>${dotHtml}${title}</div><div class="sk-actions"><button class="sk-btn" onclick="event.stopPropagation(); editShape(${idx})">âœï¸</button><button class="sk-btn" style="color:red;" onclick="event.stopPropagation(); deleteShape(${idx})">ğŸ—‘ï¸</button></div>`;
                sidekickList.appendChild(item);
            });
        }
        function focusShape(idx) { focusedShapeIndex = idx; renderSidekick(); redraw(); const c = getShapeCenter(shapes[idx]); const r = canvas.getBoundingClientRect(); window.scrollTo({ top: (window.scrollY + r.top + c.y) - (window.innerHeight/2), left: (window.scrollX + r.left + c.x) - (window.innerWidth/2), behavior: 'smooth' }); }
        
        function getShapeOrigin(s) { 
            if(s.type==='rect') return {x: Math.min(s.start.x, s.end.x), y: Math.min(s.start.y, s.end.y)}; 
            let minX=Infinity, minY=Infinity; 
            s.points.forEach(p=>{ minX=Math.min(minX,p.x); minY=Math.min(minY,p.y); }); 
            return {x:minX, y:minY}; 
        }
        
        function getShapeCenter(s) { 
            if(s.type==='rect') return {x:(s.start.x+s.end.x)/2, y:(s.start.y+s.end.y)/2}; 
            let mx=Infinity, Mx=-Infinity, my=Infinity, My=-Infinity; s.points.forEach(p=>{mx=Math.min(mx,p.x);Mx=Math.max(Mx,p.x);my=Math.min(my,p.y);My=Math.max(My,p.y);}); return {x:(mx+Mx)/2, y:(my+My)/2}; 
        }

        function toggleLabels() {
            showFullLabels = !showFullLabels;
            btnToggleLabel.innerText = showFullLabels ? "ğŸ‘ï¸ éš±è—éƒ¨åˆ†æ¨™ç±¤" : "ğŸ‘ï¸ é¡¯ç¤ºå®Œæ•´æ¨™ç±¤";
            redraw();
        }

        function isPointInPolygon(p, points) {
            let inside = false;
            for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i].x, yi = points[i].y;
                const xj = points[j].x, yj = points[j].y;
                const intersect = ((yi > p.y) !== (yj > p.y)) && (p.x < (xj - xi) * (p.y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function isMouseOverShape(s, mPos) {
            if(s.type === 'rect') {
                const minX = Math.min(s.start.x, s.end.x); const maxX = Math.max(s.start.x, s.end.x);
                const minY = Math.min(s.start.y, s.end.y); const maxY = Math.max(s.start.y, s.end.y);
                return (mPos.x >= minX && mPos.x <= maxX && mPos.y >= minY && mPos.y <= maxY);
            } else {
                return isPointInPolygon(mPos, s.points);
            }
        }

        function redraw() {
            ctx.clearRect(0,0,canvas.width,canvas.height); if(image.src) ctx.drawImage(image,0,0); ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            shapes.forEach((s,i)=>{
                const isHover = isMouseOverShape(s, lastMousePos);
                drawShape(s, true, i===focusedShapeIndex, i, isHover);
            });
            if(currentShape && tool==='rect') drawShape(currentShape,false);
            if(currentShape && tool==='poly') { ctx.beginPath(); ctx.moveTo(currentShape.points[0].x,currentShape.points[0].y); for(let p of currentShape.points) ctx.lineTo(p.x,p.y); ctx.strokeStyle='#ff0055'; ctx.lineWidth=2; ctx.stroke(); }
        }

        function drawShape(s, conf, act, idx=-1, isHover=false) {
            ctx.beginPath(); if(s.type==='rect'){const w=s.end.x-s.start.x,h=s.end.y-s.start.y; ctx.rect(s.start.x,s.start.y,w,h);}else{ctx.moveTo(s.points[0].x,s.points[0].y);for(let p of s.points)ctx.lineTo(p.x,p.y);ctx.closePath();}
            
            if(conf){
                ctx.strokeStyle=act?"#FFD700":"#fff"; ctx.lineWidth=act?4:2; ctx.fillStyle=act?"rgba(255,215,0,0.3)":"rgba(255,255,255,0.05)"; ctx.fill(); ctx.stroke();

                const origin = getShapeOrigin(s);
                let by = origin.y - 10; 
                if (by < 15) { by = origin.y + 25; } 

                const shouldShowLabel = showFullLabels || isHover || act;
                const bx = origin.x; 

                ctx.beginPath(); 
                ctx.arc(bx, by, 12, 0, Math.PI*2); 
                ctx.fillStyle = "#333"; ctx.fill(); 
                ctx.strokeStyle = "#fff"; ctx.lineWidth=2; ctx.stroke();
                ctx.fillStyle = "#fff"; ctx.font = "bold 12px monospace"; ctx.textAlign = "center"; 
                ctx.fillText(idx+1, bx, by+4);

                if (shouldShowLabel) {
                    ctx.font="14px sans-serif"; 
                    const tm=ctx.measureText(s.title); 
                    const hasS=!!s.statusColor; 
                    const pd=hasS?25:12; 
                    const bw=tm.width+pd;
                    
                    const labelX = bx + 15;
                    const labelY = by; 

                    ctx.fillStyle = act ? "rgba(250, 173, 20, 0.9)" : "rgba(40, 167, 69, 0.85)"; 
                    ctx.beginPath(); 
                    ctx.roundRect(labelX, labelY - 12, bw, 24, 4); 
                    ctx.fill();
                    
                    ctx.textAlign="start";
                    ctx.fillStyle = "#fff"; 
                    ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=2;
                    ctx.fillText(s.title, labelX + (hasS?20:6), labelY + 5);
                    ctx.shadowBlur=0;

                    if(hasS){
                        ctx.beginPath(); ctx.arc(labelX+10, labelY, 4, 0, Math.PI*2); 
                        ctx.fillStyle=s.statusColor; ctx.fill(); ctx.strokeStyle="rgba(0,0,0,0.2)"; ctx.lineWidth=1; ctx.stroke();
                    }
                }

            } else { ctx.strokeStyle="#ff0055"; ctx.lineWidth=2; ctx.stroke(); }
        }

        function openEditor(s, idx) {
            isEditingNote = false; tempShape = s; editingShapeIndex = idx;
            document.getElementById('modalTitle').innerText = idx === -1 ? "ğŸ“ æ–°å¢å€åŸŸ" : "ğŸ“ ç·¨è¼¯å€åŸŸ";
            document.getElementById('titleGroup').classList.remove('hidden'); statusGroup.classList.remove('hidden'); btnGenLegend.classList.add('hidden'); refImgGroup.classList.remove('hidden');
            duplicateBtnGroup.classList.toggle('hidden', idx === -1);

            inputTitle.value = idx === -1 ? ("é …ç›® " + (shapes.length + 1)) : s.title;
            inputDesc.value = idx === -1 ? "" : s.desc.replace(/<br>/g, '\n');
            inputStatusText.value = s.statusText || ""; selectColor(s.statusColor || "");
            
            tempRefImgBase64 = s.refImage || "";
            if(tempRefImgBase64) { refImgPreview.src = tempRefImgBase64; refImgPreviewContainer.classList.remove('hidden'); refImgPlaceholder.classList.add('hidden'); } 
            else { removeRefImg(); }

            renderQuickTags(); modal.classList.add('show'); inputTitle.focus();
        }

        function duplicateShape() {
            if(!tempShape) return;
            const newShape = JSON.parse(JSON.stringify(tempShape));
            newShape.title += " (è¤‡è£½)"; newShape.desc=""; newShape.statusText=""; newShape.statusColor="";
            shapes.push(newShape); focusedShapeIndex = shapes.length - 1;
            modal.classList.remove('show'); renderSidekick(); redraw();
            setTimeout(() => { openEditor(shapes[focusedShapeIndex], focusedShapeIndex); }, 300);
        }

        function editGlobalNote() {
            isEditingNote = true; document.getElementById('modalTitle').innerText = "ğŸ“‹ å°ˆæ¡ˆç­†è¨˜";
            document.getElementById('titleGroup').classList.add('hidden'); statusGroup.classList.add('hidden');
            duplicateBtnGroup.classList.add('hidden'); btnGenLegend.classList.remove('hidden'); refImgGroup.classList.add('hidden');
            inputDesc.value = globalNote.replace(/<br>/g, '\n'); modal.classList.add('show');
        }

        function cancelModal() { tempShape = null; modal.classList.remove('show'); redraw(); }

        function saveModal() {
            let formattedDesc = inputDesc.value.replace(/\n/g, '<br>');
            if (isEditingNote) { globalNote = formattedDesc; } 
            else {
                if(!tempShape) return;
                tempShape.title = inputTitle.value || "æœªå‘½å";
                tempShape.desc = formattedDesc;
                tempShape.statusText = inputStatusText.value;
                tempShape.statusColor = inputStatusColor.value;
                tempShape.refImage = tempRefImgBase64; 

                if(editingShapeIndex === -1) { shapes.push(tempShape); focusedShapeIndex = shapes.length - 1; } 
                else { shapes[editingShapeIndex] = tempShape; focusedShapeIndex = editingShapeIndex; }
            }
            modal.classList.remove('show'); renderSidekick(); redraw();
        }

        function addHighlight() { const t = inputDesc; const s = t.selectionStart; const e = t.selectionEnd; if(s===e)return; t.value = t.value.substring(0,s)+`<span class="highlight-text">${t.value.substring(s,e)}</span>`+t.value.substring(e); }
        function deleteShape(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { shapes.splice(i, 1); focusedShapeIndex = -1; renderSidekick(); redraw(); } }
        function editShape(i) { openEditor(shapes[i], i); }
        function undo() { shapes.pop(); renderSidekick(); redraw(); }
        function clearAll() { if(confirm("æ¸…ç©ºç•«å¸ƒï¼Ÿ")) { shapes = []; globalNote=""; renderSidekick(); redraw(); } }
        function getRegionImage(s) {
            const c = document.createElement('canvas'); const ct = c.getContext('2d');
            let x, y, w, h; if (s.type === 'rect') { x = Math.min(s.start.x, s.end.x); y = Math.min(s.start.y, s.end.y); w = Math.abs(s.end.x - s.start.x); h = Math.abs(s.end.y - s.start.y); } else { let mx=Infinity, Mx=-Infinity, my=Infinity, My=-Infinity; s.points.forEach(p=>{mx=Math.min(mx,p.x);Mx=Math.max(Mx,p.x);my=Math.min(my,p.y);My=Math.max(My,p.y);}); x=mx; y=my; w=Mx-mx; h=My-my; }
            const p=10; x=Math.max(0,x-p); y=Math.max(0,y-p); w=w+p*2; h=h+p*2; c.width=w; c.height=h; ct.drawImage(image,x,y,w,h,0,0,w,h); return c.toDataURL('image/jpeg', 0.8);
        }

        async function downloadRealExcel() {
            if(shapes.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('å°ˆæ¡ˆå ±è¡¨');
            ws.columns = [ {header:'ID',key:'id',width:8}, {header:'æˆªåœ–å¿«ç…§ (Snapshot)',key:'thumb',width:35}, {header:'åƒè€ƒåœ– (Reference)',key:'ref',width:35}, {header:'æ¨™é¡Œ',key:'title',width:30}, {header:'ç‹€æ…‹',key:'status',width:15}, {header:'èªªæ˜',key:'desc',width:50} ];
            ws.getRow(1).font={bold:true,color:{argb:'FFFFFFFF'}}; ws.getRow(1).fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF444444'}}; ws.getRow(1).alignment={vertical:'middle',horizontal:'center'};

            for (let i = 0; i < shapes.length; i++) {
                const s = shapes[i]; const rId = i + 2;
                const stC = s.statusColor?s.statusColor.replace('#',''):'FFFFFF';
                const fC = (stC==='dc3545'||stC==='217346'||stC==='007bff')?'FFFFFFFF':'FF000000';
                
                const row = ws.getRow(rId);
                row.values = { id:i+1, title:s.title, status:s.statusText, desc:(s.desc||"").replace(/<br>/g,'\n').replace(/<[^>]+>/g,'') };
                row.height = 100;
                
                row.getCell('id').alignment={vertical:'middle',horizontal:'center'};
                row.getCell('title').alignment={vertical:'middle',wrapText:true};
                row.getCell('desc').alignment={vertical:'middle',wrapText:true};
                const sc = row.getCell('status'); sc.alignment={vertical:'middle',horizontal:'center'}; sc.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF'+stC}}; sc.font={color:{argb:fC},bold:true};

                const snapId = wb.addImage({ base64: getRegionImage(s), extension: 'jpeg' });
                ws.addImage(snapId, { tl:{col:1.1,row:rId-1+0.1}, br:{col:1.9,row:rId-0.1}, editAs:'oneCell' });

                if(s.refImage) {
                    const refId = wb.addImage({ base64: s.refImage, extension: 'jpeg' });
                    ws.addImage(refId, { tl:{col:2.1,row:rId-1+0.1}, br:{col:2.9,row:rId-0.1}, editAs:'oneCell' });
                } else {
                    row.getCell('ref').value = "(ç„¡)";
                    row.getCell('ref').alignment={vertical:'middle',horizontal:'center',color:{argb:'FF999999'}};
                }
            }
            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            let n = fileNameInput.value.trim(); if(!n) n = "project_report_v30"; link.download = n + ".xlsx"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length === 0) { alert("è«‹å…ˆç¹ªè£½"); return; }
            const rd = { imgData: originalImageDataUrl, shapes: shapes, globalNote: globalNote };
            
            const safeNote = globalNote ? globalNote.replace(/\n/g, '<br>') : "ç„¡å°ˆæ¡ˆç­†è¨˜";

            let svgC = ''; let listHtml = '';
            
            const pS = shapes.map((s, idx) => { 
                const origin = getShapeOrigin(s); 
                let by = origin.y - 10;
                if(by < 15) by = origin.y + 25;
                return { ...s, bx: origin.x, by: by, id: idx + 1 }; 
            });

            pS.forEach((s, index) => {
                const id = `region-${index}`;
                let shH = ''; if(s.type === 'rect') { const w = Math.abs(s.end.x - s.start.x); const h = Math.abs(s.end.y - s.start.y); const x = Math.min(s.start.x, s.end.x); const y = Math.min(s.start.y, s.end.y); shH = `<rect x="${x}" y="${y}" width="${w}" height="${h}" />`; } else { const p = s.points.map(pt => `${pt.x},${pt.y}`).join(' '); shH = `<polygon points="${p}" />`; }
                
                svgC += `<g id="svg-${id}" class="interactive-group" onclick="activateRegion('${id}')" onmouseenter="hoverRegion('${id}', true)" onmouseleave="hoverRegion('${id}', false)">
                            ${shH}
                            <circle cx="${s.bx}" cy="${s.by}" r="12" class="badge-bg" />
                            <text x="${s.bx}" y="${s.by}" dy="4" text-anchor="middle" class="badge-text">${s.id}</text>
                        </g>`;
                
                let badge = ''; if(s.statusText) { const bg = s.statusColor || '#6c757d'; badge = `<span class="status-badge" style="background-color:${bg}">${s.statusText}</span>`; }
                
                const hasDesc = !!s.desc; const hasRef = !!s.refImage; const isEmpty = !hasDesc && !hasRef; const itemClass = isEmpty ? 'list-item title-only' : 'list-item';
                let contentHtml = '';
                if(!isEmpty) {
                    let refHtml = hasRef ? `<div style="margin-top:10px; border-top:1px dashed #555; padding-top:10px;"><div style="font-size:0.8em; color:#aaa; margin-bottom:5px;">ğŸ“Œ åƒè€ƒç¯„ä¾‹ï¼š</div><img src="${s.refImage}" style="max-width:100%; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>` : '';
                    contentHtml = `<div class="item-desc">${s.desc}${refHtml}</div>`;
                }

                listHtml += `<div class="${itemClass}" id="list-${id}" onclick="activateRegion('${id}')" onmouseenter="hoverRegion('${id}', true)" onmouseleave="hoverRegion('${id}', false)">
                                <div class="item-title">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <span class="list-num">${s.id}.</span>${s.title} ${badge}
                                    </div>
                                </div>
                                ${contentHtml}
                            </div>`;
            });

            const html = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>å°ˆæ¡ˆå°è¦½</title><style>
                body { margin:0; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; overflow: hidden; }
                .layout-container { display: flex; width: 100%; height: 100%; }
                .map-section { flex: 3; position: relative; background: #222; overflow: auto; display: flex; justify-content: center; align-items: flex-start; border-right: 1px solid #333; }
                .stage { position: relative; margin-top: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); transform-origin: top center; transition: transform 0.2s; }
                img { display: block; max-width: 100%; } .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
                .interactive-group { cursor: pointer; pointer-events: auto; }
                .interactive-group rect, .interactive-group polygon { fill: rgba(255,255,255,0.05); stroke: rgba(255,255,255,0.5); stroke-width: 1; transition: 0.2s; }
                .badge-bg { fill: rgba(0,0,0,0.6); stroke: #fff; stroke-width: 1; transition: 0.2s; } .badge-text { fill: #fff; font-size: 12px; font-weight: bold; font-family: sans-serif; pointer-events: none; }
                .interactive-group:hover rect, .interactive-group:hover polygon { stroke: #FFD700; stroke-width: 3; fill: rgba(255, 215, 0, 0.1); }
                .interactive-group:hover .badge-bg { fill: #FFD700; stroke: #000; } 
                .interactive-group.active rect, .interactive-group.active polygon { stroke: #28a745; stroke-width: 4; fill: rgba(40,167,69,0.2); animation: pulse 2s infinite; }
                .interactive-group.active .badge-bg { fill: #28a745; stroke: #fff; } 
                @keyframes pulse { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.5; } 100% { stroke-opacity: 1; } }
                .sidebar { flex: 1; min-width: 350px; max-width: 450px; background: #2b2b2b; color: #fff; display: flex; flex-direction: column; z-index: 20; border-left: 1px solid #444; }
                .sidebar-header { padding: 15px 20px; background: #333; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
                .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
                .list-item { background: #383838; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
                .list-item:hover { background: #444; border-left-color: #FFD700; }
                .list-item.active { background: #444; border-left-color: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.2); }
                .item-title { padding: 12px 15px; font-weight: bold; font-size: 1.05em; display: flex; justify-content: space-between; align-items: center; }
                .list-item:not(.title-only) .item-title::after { content: '+'; color: #888; font-weight: normal; }
                .list-item.active:not(.title-only) .item-title::after { content: 'âˆ’'; color: #fff; }
                .list-item.title-only { padding: 5px 0; background: #333; border: 1px solid #444; }
                .list-item.title-only:hover { background: #3a3a3a; }
                .list-item.title-only .item-title { padding: 8px 15px; font-size: 1em; color: #ddd; }
                .list-num { color: #888; margin-right: 5px; font-family: monospace; } .list-item.active .list-num { color: #28a745; }
                .item-desc { padding: 0 15px; max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s; color: #ddd; line-height: 1.6; font-size: 0.95em; border-top: 1px solid rgba(255,255,255,0.05); }
                .list-item.active .item-desc { padding: 15px; max-height: 1500px; opacity: 1; }
                .status-badge { font-size: 0.75em; color: #fff; padding: 2px 8px; border-radius: 10px; vertical-align: middle; }
                .highlight-text { background-color: #ffeb3b; color: #000; padding: 2px 4px; border-radius: 3px; }
                .zoom-controls { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 100; }
                .zoom-btn { background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
                .zoom-btn:hover { background: #28a745; border-color: #28a745; }
                .note-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); } .note-card { background: #2b2b2b; color: #eee; width: 80%; max-width: 700px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #555; } .note-body { padding: 30px; overflow-y: auto; line-height: 1.8; font-size: 1.1em; white-space: pre-wrap; }
            </style></head><body>
            <div class="layout-container"><div class="map-section" id="mapSection"><div class="stage" id="stage" style="width: 95%;"><img src="${rd.imgData}"><svg class="overlay" viewBox="0 0 ${canvas.width} ${canvas.height}">${svgC}</svg></div><div class="zoom-controls"><button class="zoom-btn" onclick="setZoom(100)">100%</button><button class="zoom-btn" onclick="setZoom('fit')">Fit</button><button class="zoom-btn" onclick="zoomIn()">+</button><button class="zoom-btn" onclick="zoomOut()">-</button></div></div><div class="sidebar"><div class="sidebar-header"><div style="font-size:1.2em; font-weight:bold; color:#28a745;">ğŸ“‹ å°ˆæ¡ˆå°è¦½</div><button style="background:#6610f2; color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer;" onclick="toggleNote()">å°ˆæ¡ˆç­†è¨˜</button></div><div class="sidebar-content" id="sidebarList">${listHtml}</div></div></div>
            <div class="note-modal" id="noteModal" onclick="toggleNote()"><div class="note-card" onclick="event.stopPropagation()"><div style="padding:15px 20px; border-bottom:1px solid #444; font-weight:bold; background:#333; border-radius:12px 12px 0 0;">ğŸ“Œ å°ˆæ¡ˆç­†è¨˜</div><div class="note-body">${safeNote}</div></div></div>
            <script id="restore-data" type="application/json">${JSON.stringify(rd)}<\/script>
            <script>
                let currentZoom=95; const stage=document.getElementById('stage'); function updateZoom(){stage.style.width=currentZoom+'%';} function zoomIn(){currentZoom+=10;updateZoom();} function zoomOut(){if(currentZoom>20)currentZoom-=10;updateZoom();} function setZoom(v){currentZoom=(v==='fit')?95:100;updateZoom();}
                let activeId=null;
                function activateRegion(id){
                    if(activeId===id){deactivate();return;} if(activeId)deactivate(); activeId=id;
                    document.getElementById('svg-'+id)?.classList.add('active');
                    const item = document.getElementById('list-'+id);
                    if(item){ item.classList.add('active'); item.scrollIntoView({behavior:'smooth',block:'center'}); }
                }
                function deactivate(){ if(!activeId)return; document.getElementById('svg-'+activeId)?.classList.remove('active'); document.getElementById('list-'+activeId)?.classList.remove('active'); activeId=null; }
                function hoverRegion(id,en){ 
                    if(activeId===id)return; 
                    const s=document.getElementById('svg-'+id); 
                    const l=document.getElementById('list-'+id); 
                    if(en){
                        s?.classList.add('hovered');
                        l?.classList.add('hovered');
                        // V30: å°‡ hover çš„å…ƒç´ ç§»åˆ°æœ€ä¸Šå±¤ï¼Œé¿å…è¢«é®æ“‹
                        if(s) s.parentNode.appendChild(s);
                    }else{
                        s?.classList.remove('hovered');
                        l?.classList.remove('hovered');
                    } 
                }
                function toggleNote(){ const m=document.getElementById('noteModal'); m.style.display=(m.style.display==='flex')?'none':'flex'; }
            <\/script></body></html>`;

            const blob = new Blob([html], { type: "text/html" });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            let n = fileNameInput.value.trim(); if(!n) n = "project_report_v30"; link.download = n + ".html"; link.click();
        }
    </script>
</body>
</html>
