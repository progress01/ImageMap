<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map 生成器 (含文字輸入)</title>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .toolbar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        button { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #f0f0f0; }
        button.active { background: #007bff; color: white; border-color: #007bff; }
        button.primary { background: #28a745; color: white; border-color: #28a745; }
        button.danger { color: #d9534f; border-color: #d9534f; }
        #canvas-container { position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 2px solid #ccc; background-color: #eee; min-width: 300px; min-height: 200px; cursor: crosshair; }
        .row { display: flex; gap: 20px; width: 100%; max-width: 1200px; justify-content: center; align-items: flex-start; }
        .col { display: flex; flex-direction: column; align-items: center; }
        textarea { width: 100%; height: 100px; margin-top: 10px; }
        .tips { color: #666; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>Image Map 生成器 (自訂文字版)</h1>

    <div class="toolbar">
        <input type="file" id="imgInput" accept="image/*">
        <div style="border-left: 1px solid #ccc; margin: 0 5px;"></div>
        <button id="btnRect" class="active" onclick="setTool('rect')">畫矩形 (Rect)</button>
        <button id="btnPoly" onclick="setTool('poly')">畫多邊形 (Poly)</button>
        <div style="border-left: 1px solid #ccc; margin: 0 5px;"></div>
        <button onclick="undo()">上一步</button>
        <button class="danger" onclick="clearAll()">清除全部</button>
        <div style="border-left: 1px solid #ccc; margin: 0 5px;"></div>
        <button class="primary" onclick="downloadStandalone()">下載展示用 HTML</button>
    </div>

    <div class="row">
        <div class="col">
            <div id="canvas-container">
                <canvas id="editorCanvas"></canvas>
            </div>
            <p class="tips">操作提示：畫完圖形後，會自動彈出視窗讓你輸入「說明文字」與「連結」。</p>
        </div>
    </div>
    
    <div style="width: 100%; max-width: 800px; margin-top: 20px;">
        <details>
            <summary>查看生成的標準 HTML 代碼</summary>
            <textarea id="outputCode" readonly></textarea>
        </details>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        
        let image = new Image();
        let shapes = []; 
        let currentShape = null; 
        let isDrawing = false;
        let tool = 'rect'; 
        let originalImageDataUrl = "";

        canvas.width = 600;
        canvas.height = 400;
        ctx.fillStyle = "#eee";
        ctx.fillRect(0,0,600,400);
        ctx.fillStyle = "#555";
        ctx.font = "20px sans-serif";
        ctx.fillText("請先上傳圖片", 240, 200);

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImageDataUrl = event.target.result;
                image.onload = () => {
                    canvas.width = image.width;
                    canvas.height = image.height;
                    shapes = [];
                    currentShape = null;
                    redraw();
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null;
            redraw();
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect') {
                isDrawing = true;
                currentShape = { type: 'rect', start: pos, end: pos };
            } else if (tool === 'poly') {
                if (!currentShape) currentShape = { type: 'poly', points: [pos] };
                else currentShape.points.push(pos);
            }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) {
                currentShape.end = pos;
                redraw();
            } else if (tool === 'poly' && currentShape) {
                redraw();
                ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        // --- 核心修改：畫完後跳出輸入框 (Rect) ---
        canvas.addEventListener('mouseup', (e) => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 5) {
                    addShapeWithPrompt(currentShape);
                }
                currentShape = null;
                redraw();
                updateCode();
            }
        });

        // --- 核心修改：畫完後跳出輸入框 (Poly) ---
        canvas.addEventListener('dblclick', (e) => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                addShapeWithPrompt(currentShape);
                currentShape = null;
                redraw();
                updateCode();
            }
        });

        // --- 新增：處理輸入邏輯 ---
        function addShapeWithPrompt(shapeData) {
            // 延遲一點點讓 Canvas 先畫完最後一筆，視覺上比較順
            setTimeout(() => {
                const defaultTitle = "區域 " + (shapes.length + 1);
                const title = prompt("請輸入此區域的【說明文字】\n(滑鼠移上去時顯示)", defaultTitle);
                
                // 如果使用者按取消，我們還是讓他建立，只是用預設值，或者你可以選擇 return 不建立
                const finalTitle = title !== null ? title : defaultTitle;
                
                const link = prompt("請輸入此區域的【連結網址】\n(點擊後跳轉，不需要可留空)", "#");
                const finalLink = link !== null && link !== "" ? link : "#";

                shapeData.title = finalTitle;
                shapeData.href = finalLink;
                
                shapes.push(shapeData);
                redraw();
                updateCode();
            }, 10);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: Math.round((e.clientX - rect.left) * scaleX),
                y: Math.round((e.clientY - rect.top) * scaleY)
            };
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            
            ctx.fillStyle = "rgba(0,0,0,0.1)"; 
            
            shapes.forEach((shape, i) => {
                drawShape(shape, '#007bff');
                // 在圖上標示簡單的文字，方便辨識
                const center = getCenter(shape);
                ctx.fillStyle = "white";
                ctx.font = "12px Arial";
                ctx.fillText(shape.title || ("區域 "+(i+1)), center.x, center.y);
            });

            if (currentShape && tool === 'rect') drawShape(currentShape, '#ff0000');
            
            if (currentShape && tool === 'poly') {
                ctx.beginPath();
                ctx.moveTo(currentShape.points[0].x, currentShape.points[0].y);
                for (let i = 1; i < currentShape.points.length; i++) ctx.lineTo(currentShape.points[i].x, currentShape.points[i].y);
                ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function getCenter(shape) {
            if (shape.type === 'rect') {
                return {
                    x: shape.start.x + (shape.end.x - shape.start.x)/2 - 20,
                    y: shape.start.y + (shape.end.y - shape.start.y)/2
                };
            } else {
                // 簡單取第一個點當標示位置
                return shape.points[0];
            }
        }

        function drawShape(shape, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.fillStyle = color === '#007bff' ? "rgba(0, 123, 255, 0.3)" : "rgba(255, 0, 0, 0.3)";

            if (shape.type === 'rect') {
                const w = shape.end.x - shape.start.x;
                const h = shape.end.y - shape.start.y;
                ctx.strokeRect(shape.start.x, shape.start.y, w, h);
                ctx.fillRect(shape.start.x, shape.start.y, w, h);
            } else if (shape.type === 'poly') {
                ctx.beginPath();
                ctx.moveTo(shape.points[0].x, shape.points[0].y);
                for (let i = 1; i < shape.points.length; i++) ctx.lineTo(shape.points[i].x, shape.points[i].y);
                ctx.closePath();
                ctx.stroke();
                ctx.fill();
            }
        }

        function undo() { shapes.pop(); redraw(); updateCode(); }
        function clearAll() { if(confirm('清除所有？')) { shapes = []; currentShape = null; redraw(); updateCode(); } }

        function updateCode() {
            document.getElementById('outputCode').value = generateMapHTML();
        }

        function generateMapHTML() {
            let areas = '';
            shapes.forEach((shape, i) => {
                let coords = '';
                if (shape.type === 'rect') {
                    const x1 = Math.min(shape.start.x, shape.end.x), y1 = Math.min(shape.start.y, shape.end.y);
                    const x2 = Math.max(shape.start.x, shape.end.x), y2 = Math.max(shape.start.y, shape.end.y);
                    coords = `${x1},${y1},${x2},${y2}`;
                } else {
                    coords = shape.points.map(p => `${p.x},${p.y}`).join(',');
                }
                // 把輸入的標題和連結填進去
                areas += `    <area shape="${shape.type}" coords="${coords}" href="${shape.href}" alt="${shape.title}" title="${shape.title}">\n`;
            });
            return `<map name="generated-map">\n${areas}</map>`;
        }

        function downloadStandalone() {
            if(!originalImageDataUrl || shapes.length === 0) {
                alert("請先繪製區域！");
                return;
            }

            let svgContent = '';
            shapes.forEach((shape, i) => {
                let shapeEl = '';
                if(shape.type === 'rect') {
                    const x = Math.min(shape.start.x, shape.end.x);
                    const y = Math.min(shape.start.y, shape.end.y);
                    const w = Math.abs(shape.end.x - shape.start.x);
                    const h = Math.abs(shape.end.y - shape.start.y);
                    shapeEl = `<rect x="${x}" y="${y}" width="${w}" height="${h}"`;
                } else {
                    const points = shape.points.map(p => `${p.x},${p.y}`).join(' ');
                    shapeEl = `<polygon points="${points}"`;
                }
                
                // 這裡把連結和標題塞進 data 屬性
                svgContent += `${shapeEl} class="highlight-area" data-title="${shape.title}" data-href="${shape.href}"></${shape.type === 'rect' ? 'rect' : 'polygon'}>`;
            });

            const fileContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Image Map 展示</title>
    <style>
        body { background: #333; display: flex; justify-content: center; padding: 20px; font-family: sans-serif; }
        .container { position: relative; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.5); background: white; }
        img { display: block; max-width: 100%; height: auto; }
        .overlay-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .highlight-area {
            fill: rgba(255, 255, 255, 0); 
            stroke: rgba(255, 0, 0, 0.5);
            stroke-width: 2;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s;
        }
        .highlight-area:hover {
            fill: rgba(255, 255, 0, 0.3);
            stroke: red;
            stroke-width: 3;
        }
        .tooltip {
            position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; 
            border-radius: 4px; font-size: 14px; pointer-events: none; display: none; z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="${originalImageDataUrl}">
        <svg class="overlay-svg" viewBox="0 0 ${canvas.width} ${canvas.height}">
            ${svgContent}
        </svg>
        <div id="tooltip" class="tooltip"></div>
    </div>
    <script>
        const tooltip = document.getElementById('tooltip');
        const areas = document.querySelectorAll('.highlight-area');
        
        areas.forEach(area => {
            // 滑鼠移入：顯示你輸入的說明文字
            area.addEventListener('mousemove', (e) => {
                tooltip.style.display = 'block';
                tooltip.textContent = area.getAttribute('data-title');
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            });
            area.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });
            
            // 點擊：如果有連結就開啟，沒有就跳 alert
            area.addEventListener('click', () => {
                const link = area.getAttribute('data-href');
                const title = area.getAttribute('data-title');
                if(link && link !== '#') {
                    window.open(link, '_blank');
                } else {
                    alert('這是：' + title + ' (未設定連結)');
                }
            });
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([fileContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "demo-map-with-text.html";
            link.click();
        }
    </script>
</body>
</html>
