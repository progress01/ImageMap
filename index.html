<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map 簡報生成器 (V3)</title>
    <style>
        /* 介面樣式 */
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        .toolbar { background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; display: flex; gap: 15px; align-items: center; }
        button { padding: 8px 20px; border: 1px solid #ddd; background: #fff; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.4); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 2px 5px rgba(40,167,69,0.4); }
        button.danger { color: #dc3545; border-color: #dc3545; }
        button.danger:hover { background: #dc3545; color: white; }
        
        /* 畫布區 */
        #canvas-wrapper { position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 4px solid white; border-radius: 4px; overflow: hidden; background: #ddd; }
        canvas { display: block; cursor: crosshair; }
        
        .instructions { color: #666; margin-bottom: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1>Image Map 簡報製作工具</h1>
    <p class="instructions">上傳圖片 -> 框選區域 -> 輸入「標題」與「詳細解說」 -> 下載展示檔</p>

    <div class="toolbar">
        <input type="file" id="imgInput" accept="image/*">
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <button id="btnRect" class="active" onclick="setTool('rect')">矩形</button>
        <button id="btnPoly" onclick="setTool('poly')">多邊形 (點兩下結束)</button>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <button onclick="undo()">復原</button>
        <button class="danger" onclick="clearAll()">清空</button>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <button class="primary" onclick="downloadPresentation()">下載簡報展示檔 (HTML)</button>
    </div>

    <div id="canvas-wrapper">
        <canvas id="editorCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        
        let image = new Image();
        let shapes = []; 
        let currentShape = null; 
        let isDrawing = false;
        let tool = 'rect'; 
        let originalImageDataUrl = "";

        // 初始化畫布
        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#888"; ctx.font = "24px sans-serif"; ctx.fillText("請上傳一張圖片開始製作", 260, 250);

        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImageDataUrl = event.target.result;
                image.onload = () => {
                    canvas.width = image.width; canvas.height = image.height;
                    shapes = []; currentShape = null; redraw();
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null; redraw();
        }

        // --- 滑鼠事件邏輯 ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect') {
                isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos };
            } else if (tool === 'poly') {
                if (!currentShape) currentShape = { type: 'poly', points: [pos] };
                else currentShape.points.push(pos);
            }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) {
                currentShape.end = pos; redraw();
            } else if (tool === 'poly' && currentShape) {
                redraw();
                ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 10) addShapePrompt(currentShape);
                currentShape = null; redraw();
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                addShapePrompt(currentShape);
                currentShape = null; redraw();
            }
        });

        // --- 核心：輸入資料 ---
        function addShapePrompt(shape) {
            setTimeout(() => {
                const title = prompt("【標題】請輸入這個區域的名稱：", "區域 " + (shapes.length + 1));
                if(title === null) return; // 取消
                
                // 這裡改為輸入「詳細內容」
                const desc = prompt("【內容】請輸入點擊後要顯示的詳細解說：\n(支援 HTML 標籤，如 <br> 換行)", "這裡是關於 " + title + " 的詳細說明...");
                
                shape.title = title || "未命名區域";
                shape.desc = desc || "無詳細說明";
                shapes.push(shape);
                redraw();
            }, 10);
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            
            // 遮罩
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(0,0,canvas.width,canvas.height);

            shapes.forEach((s, i) => drawShape(s, true));
            if (currentShape && tool === 'rect') drawShape(currentShape, false);
            if (currentShape && tool === 'poly') {
                // 繪製多邊形過程
                ctx.beginPath();
                ctx.moveTo(currentShape.points[0].x, currentShape.points[0].y);
                for(let p of currentShape.points) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function drawShape(s, isConfirmed) {
            ctx.beginPath();
            if (s.type === 'rect') {
                const w = s.end.x - s.start.x;
                const h = s.end.y - s.start.y;
                ctx.rect(s.start.x, s.start.y, w, h);
            } else {
                ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let p of s.points) ctx.lineTo(p.x, p.y);
                ctx.closePath();
            }

            if(isConfirmed) {
                ctx.fillStyle = "rgba(255, 255, 255, 0.1)"; // 挖洞效果
                ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
                
                // 畫標題標籤
                let center = s.type === 'rect' ? {x:s.start.x, y:s.start.y} : s.points[0];
                ctx.font = "14px sans-serif";
                const textMetrics = ctx.measureText(s.title);
                ctx.fillStyle = "#007bff";
                ctx.fillRect(center.x, center.y - 20, textMetrics.width + 10, 20);
                ctx.fillStyle = "white";
                ctx.fillText(s.title, center.x + 5, center.y - 5);
            } else {
                ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function undo() { shapes.pop(); redraw(); }
        function clearAll() { if(confirm("確定清空？")) { shapes = []; redraw(); } }

        // --- 核心：下載簡報展示檔 ---
        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length === 0) { alert("請先繪圖！"); return; }

            // 產生 SVG 互動層
            let svgContent = '';
            shapes.forEach((s, i) => {
                let attrs = '';
                if(s.type === 'rect') {
                    const w = Math.abs(s.end.x - s.start.x);
                    const h = Math.abs(s.end.y - s.start.y);
                    const x = Math.min(s.start.x, s.end.x);
                    const y = Math.min(s.start.y, s.end.y);
                    attrs = `x="${x}" y="${y}" width="${w}" height="${h}"`;
                    // SVG rect
                    svgContent += `<rect ${attrs} class="interactive-area" data-title="${s.title}" data-desc="${s.desc.replace(/"/g, '&quot;')}"></rect>`;
                } else {
                    const points = s.points.map(p => `${p.x},${p.y}`).join(' ');
                    // SVG polygon
                    svgContent += `<polygon points="${points}" class="interactive-area" data-title="${s.title}" data-desc="${s.desc.replace(/"/g, '&quot;')}"></polygon>`;
                }
            });

            const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>互動展示簡報</title>
    <style>
        body { margin:0; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        .stage { position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); max-width: 95vw; max-height: 95vh; }
        img { display: block; max-width: 100%; max-height: 95vh; user-select: none; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* 互動區域樣式 */
        .interactive-area {
            fill: rgba(255,255,255,0);
            stroke: rgba(255,255,255,0.3);
            stroke-width: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        /* Hover 特效：呼吸燈與發光 */
        .interactive-area:hover {
            fill: rgba(255, 255, 255, 0.15);
            stroke: #00d2ff;
            stroke-width: 2;
            filter: drop-shadow(0 0 8px rgba(0, 210, 255, 0.6));
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { fill-opacity: 0.1; }
            50% { fill-opacity: 0.3; }
            100% { fill-opacity: 0.1; }
        }

        /* 彈出視窗 (Modal) */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 1000;
        }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: white; width: 400px; max-width: 90%;
            border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateY(20px); transition: transform 0.3s;
        }
        .modal-backdrop.show .modal-card { transform: translateY(0); }
        
        .modal-header { background: #007bff; color: white; padding: 15px 20px; font-size: 1.2em; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { padding: 25px 20px; line-height: 1.6; color: #333; font-size: 1em; max-height: 60vh; overflow-y: auto; }
        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; }
        
        /* 浮動標籤 (Tooltip) */
        .tooltip {
            position: absolute; background: rgba(0,0,0,0.85); color: white; padding: 6px 12px;
            border-radius: 4px; font-size: 14px; pointer-events: none; 
            transform: translate(-50%, -100%); margin-top: -10px;
            opacity: 0; transition: opacity 0.2s; white-space: nowrap; z-index: 10;
        }
    </style>
</head>
<body>

    <div class="stage">
        <img src="${originalImageDataUrl}">
        <svg class="overlay" viewBox="0 0 ${canvas.width} ${canvas.height}">
            ${svgContent}
        </svg>
        <div id="tooltip" class="tooltip"></div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal(event)">
        <div class="modal-card">
            <div class="modal-header">
                <span id="modalTitle">標題</span>
                <button class="close-btn" onclick="closeModalDirect()">&times;</button>
            </div>
            <div class="modal-body" id="modalDesc">
                內容...
            </div>
        </div>
    </div>

    <script>
        const backdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const modalDesc = document.getElementById('modalDesc');
        const tooltip = document.getElementById('tooltip');
        
        // 綁定所有區域事件
        document.querySelectorAll('.interactive-area').forEach(area => {
            // Hover 顯示 Tooltip
            area.addEventListener('mousemove', (e) => {
                tooltip.style.opacity = 1;
                tooltip.textContent = area.getAttribute('data-title');
                tooltip.style.left = e.pageX + 'px';
                tooltip.style.top = e.pageY + 'px';
            });
            area.addEventListener('mouseout', () => { tooltip.style.opacity = 0; });
            
            // Click 顯示 Modal
            area.addEventListener('click', (e) => {
                e.stopPropagation(); // 防止點擊穿透
                const title = area.getAttribute('data-title');
                const desc = area.getAttribute('data-desc');
                
                modalTitle.textContent = title;
                modalDesc.innerHTML = desc; // 支援 HTML
                backdrop.classList.add('show');
            });
        });

        // 關閉 Modal 邏輯
        function closeModal(e) {
            if(e.target === backdrop) backdrop.classList.remove('show');
        }
        function closeModalDirect() {
            backdrop.classList.remove('show');
        }
        
        // 按 ESC 關閉
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') closeModalDirect();
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "presentation_slide.html";
            link.click();
        }
    </script>
</body>
</html>
