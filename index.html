<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Map ç”Ÿæˆå™¨ V21 (å®Œç¾ Excel ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒä½ˆå±€ --- */
        body { 
            font-family: "Microsoft JhengHei", -apple-system, sans-serif; 
            background: #f4f6f8; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; margin: 0; 
        }

        h1 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        
        .main-controls { display: flex; gap: 15px; margin-bottom: 15px; width: 100%; justify-content: center; }
        .file-group { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }

        .toolbar { background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; z-index: 10; position: sticky; top: 10px; }
        
        button { padding: 8px 18px; border: 1px solid #ddd; background: #fff; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
        button:hover { background: #f0f0f0; transform: translateY(-1px); }
        button.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        button.primary { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
        /* Excel æŒ‰éˆ•æ¨£å¼ */
        button.excel { background: #1D6F42; color: white; border-color: #1D6F42; box-shadow: 0 4px 10px rgba(29,111,66,0.3); }
        button.duplicate { color: #fd7e14; border-color: #fd7e14; }
        button.danger { color: #dc3545; border-color: #dc3545; }
        button.info { color: #17a2b8; border-color: #17a2b8; }
        button.note { color: #6610f2; border-color: #6610f2; }

        /* --- ç•«å¸ƒå€åŸŸ --- */
        #canvas-wrapper { 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border: 4px solid white; 
            border-radius: 4px; 
            background: #ddd; 
            min-width: 600px; min-height: 400px; 
            margin-bottom: 50px;
        }
        canvas { display: block; cursor: crosshair; }

        input[type="text"].filename-input { padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; width: 180px; text-align: center; }
        input[type="text"].filename-input:focus { border-color: #28a745; }

        /* --- æ‡¸æµ®æ¸…å–® --- */
        .sidekick-panel {
            position: fixed; right: 20px; top: 100px; width: 240px;
            background: white; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #eee;
            z-index: 100; display: flex; flex-direction: column; max-height: 70vh; transition: 0.3s;
        }
        .sidekick-panel.minimized { width: 40px; height: 40px; overflow: hidden; border-radius: 50%; top: auto; bottom: 20px; }
        
        .sidekick-header {
            padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
            border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: #555; font-size: 0.9em; cursor: move;
        }
        .sidekick-toggle { cursor: pointer; padding: 0 5px; color: #999; }
        .sidekick-toggle:hover { color: #333; }
        
        .sidekick-content { flex: 1; overflow-y: auto; padding: 10px; background: #fff; border-radius: 0 0 10px 10px; }

        .sk-item {
            padding: 8px 10px; border: 1px solid #eee; margin-bottom: 6px; border-radius: 6px;
            cursor: pointer; font-size: 0.9em; border-left: 3px solid transparent;
            display: flex; justify-content: space-between; align-items: center; background: #fff;
        }
        .sk-item:hover { background: #f4f6f8; }
        .sk-item.active { border-left-color: #28a745; background: #e8f5e9; border-color: #c3e6cb; }
        .sk-actions { display: flex; gap: 4px; }
        .sk-btn { font-size: 0.8em; padding: 2px 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .sk-btn:hover { background: #eee; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        /* --- ç·¨è¼¯ Modal --- */
        .editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 999; visibility: hidden; opacity: 0; transition: 0.3s; }
        .editor-modal.show { visibility: visible; opacity: 1; }
        .editor-card { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; transform: scale(0.9); transition: 0.3s; }
        .editor-modal.show .editor-card { transform: scale(1); }
        .editor-card h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }
        
        label { font-weight: bold; font-size: 0.9em; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1em; }
        
        .status-picker { display: flex; gap: 10px; align-items: center; }
        .color-opt { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
        .color-opt:hover { transform: scale(1.1); }
        .color-opt.selected { border-color: #333; transform: scale(1.1); }
        
        .textarea-container { position: relative; }
        textarea { width: 100%; height: 160px; padding: 12px; padding-top: 45px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit; line-height: 1.6; box-sizing: border-box; font-size: 1em; }
        .textarea-toolbar { position: absolute; top: 1px; left: 1px; right: 1px; background: #f8f9fa; border-bottom: 1px solid #ddd; padding: 6px; border-radius: 6px 6px 0 0; display: flex; gap: 8px; align-items: center; }
        .tool-btn { font-size: 0.85em; padding: 4px 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .tips { font-size: 0.8em; color: #888; margin-left: auto; }
        
        .modal-footer { display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .footer-right { display: flex; gap: 10px; }
        .hidden { display: none; }
        .highlight-text { background-color: #ffeb3b; padding: 0 2px; }
    </style>
</head>
<body>

    <h1>Image Map ç”Ÿæˆå™¨ V21</h1>
    <div class="subtitle">è¦–è¦ºåŒ–ç›£æ§ -> å®Œç¾ç„¡è­¦å‘Š Excel æˆªåœ–å ±è¡¨ (V21)</div>

    <div class="main-controls">
        <div class="file-group">
            <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 1: æ–°å¢æˆ–é‚„åŸ</span>
            <button onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸ ä¸Šå‚³æ–°åœ–ç‰‡</button>
            <input type="file" id="imgInput" accept="image/*" style="display:none">
            <div style="border-left:1px solid #ddd; height:20px;"></div>
            <button class="info" onclick="document.getElementById('importInput').click()">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="importInput" accept=".html" style="display:none">
        </div>
    </div>

    <div class="toolbar">
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 2: ç¹ªè£½</span>
        <button id="btnRect" class="active" onclick="setTool('rect')">ç•«çŸ©å½¢</button>
        <button id="btnPoly" onclick="setTool('poly')">ç•«å¤šé‚Šå½¢</button>
        <button class="note" onclick="editGlobalNote()">ğŸ“ å°ˆæ¡ˆç­†è¨˜</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        <button onclick="undo()">å¾©åŸ</button>
        <button class="danger" onclick="clearAll()">æ¸…é™¤</button>
        <div style="border-left:1px solid #ddd; height:20px;"></div>
        
        <span style="font-size:0.9em; color:#666;">æ­¥é©Ÿ 3: åŒ¯å‡º</span>
        <input type="text" id="fileNameInput" class="filename-input" placeholder="æª”æ¡ˆåç¨±">
        <button class="excel" onclick="downloadRealExcel()">ğŸ“Š ä¸‹è¼‰ Excel (.xlsx)</button>
        <button class="primary" onclick="downloadPresentation()">ğŸ“¥ ä¸‹è¼‰ HTML</button>
    </div>

    <div id="canvas-wrapper">
        <canvas id="editorCanvas"></canvas>
    </div>

    <div class="sidekick-panel" id="sidekickPanel">
        <div class="sidekick-header">
            <span id="skTitle">é …ç›®åˆ—è¡¨ (0)</span>
            <span class="sidekick-toggle" onclick="toggleSidekick()" title="æœ€å°åŒ–">â–</span>
        </div>
        <div class="sidekick-content" id="sidekickList">
            <div style="text-align:center; color:#999; font-size:0.8em; margin-top:20px;">ç„¡é …ç›®</div>
        </div>
    </div>

    <div class="editor-modal" id="editorModal">
        <div class="editor-card">
            <h3 id="modalTitle">ğŸ“ ç·¨è¼¯å€åŸŸè³‡è¨Š</h3>
            
            <div id="titleGroup">
                <label>æ¨™é¡Œ (å¯ç°¡çŸ­ï¼ŒExcel æœƒæœ‰æˆªåœ–)</label>
                <input type="text" id="inputTitle" placeholder="ä¾‹å¦‚ï¼šçµå¸³æŒ‰éˆ• (åŠŸèƒ½A)">
            </div>

            <div id="statusGroup">
                <label>ç‹€æ…‹æ¨™ç±¤ (Excel æœƒé¡¯ç¤ºèƒŒæ™¯è‰²)</label>
                <div class="status-picker">
                    <input type="text" id="inputStatusText" placeholder="æ¨™ç±¤ (å¦‚: å¾…ä¿®å¾©)..." style="flex:1;">
                    <div class="color-opt" style="background:#dc3545;" onclick="selectColor('#dc3545')" title="ç´…è‰²-ç·Šæ€¥"></div>
                    <div class="color-opt" style="background:#ffc107;" onclick="selectColor('#ffc107')" title="é»ƒè‰²-é€²è¡Œä¸­"></div>
                    <div class="color-opt" style="background:#28a745;" onclick="selectColor('#28a745')" title="ç¶ è‰²-å®Œæˆ"></div>
                    <div class="color-opt" style="background:#007bff;" onclick="selectColor('#007bff')" title="è—è‰²-è³‡è¨Š"></div>
                    <div class="color-opt" style="background:#6c757d;" onclick="selectColor('#6c757d')" title="ç°è‰²-å¾…è¾¦"></div>
                </div>
                <input type="hidden" id="inputStatusColor" value="">
            </div>

            <div>
                <label>è©³ç´°å…§å®¹ (å‚™è¨»)</label>
                <div class="textarea-container">
                    <div class="textarea-toolbar">
                        <button class="tool-btn" onclick="addHighlight()">ğŸ–ï¸ é‡é»</button>
                    </div>
                    <textarea id="inputDesc" placeholder="è«‹è¼¸å…¥è©³ç´°èªªæ˜..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div id="duplicateBtnGroup">
                    <button class="duplicate" type="button" onclick="duplicateShape()">ğŸ“‹ åŸåœ°è¤‡è£½æ­¤å€</button>
                </div>
                <div class="footer-right">
                    <button onclick="cancelModal()">å–æ¶ˆ</button>
                    <button class="primary" onclick="saveModal()">ç¢ºå®šå„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const imgInput = document.getElementById('imgInput');
        const importInput = document.getElementById('importInput');
        const modal = document.getElementById('editorModal');
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');
        const inputStatusText = document.getElementById('inputStatusText');
        const inputStatusColor = document.getElementById('inputStatusColor');
        const statusGroup = document.getElementById('statusGroup');
        const fileNameInput = document.getElementById('fileNameInput');
        const sidekickPanel = document.getElementById('sidekickPanel');
        const sidekickList = document.getElementById('sidekickList');
        const skTitle = document.getElementById('skTitle');
        const duplicateBtnGroup = document.getElementById('duplicateBtnGroup');
        
        let focusedShapeIndex = -1;
        let image = new Image();
        let shapes = []; let currentShape = null; let tempShape = null; 
        let isDrawing = false; let tool = 'rect'; let originalImageDataUrl = "";
        let globalNote = ""; let isEditingNote = false; let editingShapeIndex = -1;

        canvas.width = 800; canvas.height = 500;
        ctx.fillStyle = "#e0e0e0"; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = "#666"; ctx.font = "20px sans-serif"; ctx.fillText("è«‹ä¸Šå‚³åœ–ç‰‡ (V21)", 320, 250);

        // --- æ ¸å¿ƒåœ–ç‰‡èˆ‡é‚„åŸé‚è¼¯ ---
        imgInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result);
                shapes = []; globalNote = ""; 
                fileNameInput.value = file.name.split('.')[0];
                renderSidekick();
            };
            reader.readAsDataURL(file);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const doc = new DOMParser().parseFromString(event.target.result, 'text/html');
                    const script = doc.getElementById('restore-data');
                    if (script) {
                        const data = JSON.parse(script.textContent);
                        shapes = data.shapes; globalNote = data.globalNote || "";
                        loadImage(data.imgData);
                        fileNameInput.value = file.name.split('.')[0];
                        renderSidekick();
                        alert("å°ˆæ¡ˆå·²é‚„åŸï¼");
                    } else { alert("æ ¼å¼éŒ¯èª¤"); }
                } catch(e) { alert("è®€å–å¤±æ•—"); }
            };
            reader.readAsText(file);
            importInput.value = '';
        });

        function loadImage(src) {
            originalImageDataUrl = src;
            image.onload = () => {
                canvas.width = image.width; canvas.height = image.height;
                redraw();
            };
            image.src = src;
        }

        // --- ç¹ªåœ–äº’å‹• ---
        function setTool(t) {
            tool = t;
            document.getElementById('btnRect').classList.toggle('active', t === 'rect');
            document.getElementById('btnPoly').classList.toggle('active', t === 'poly');
            currentShape = null; redraw();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!image.src) return;
            if(focusedShapeIndex !== -1 && !isDrawing) {
                focusedShapeIndex = -1; renderSidekick(); redraw();
            }
            const pos = getPos(e);
            if (tool === 'rect') { isDrawing = true; currentShape = { type: 'rect', start: pos, end: pos }; } 
            else if (tool === 'poly') { if (!currentShape) currentShape = { type: 'poly', points: [pos] }; else currentShape.points.push(pos); }
            redraw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!image.src) return;
            const pos = getPos(e);
            if (tool === 'rect' && isDrawing) { currentShape.end = pos; redraw(); } 
            else if (tool === 'poly' && currentShape) {
                redraw(); ctx.beginPath();
                const last = currentShape.points[currentShape.points.length - 1];
                ctx.moveTo(last.x, last.y); ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (tool === 'rect' && isDrawing) {
                isDrawing = false;
                if(Math.abs(currentShape.start.x - currentShape.end.x) > 10) openEditor(currentShape, -1);
                currentShape = null; redraw();
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            if (tool === 'poly' && currentShape && currentShape.points.length > 2) {
                openEditor(currentShape, -1); currentShape = null; redraw();
            }
        });

        function selectColor(color) {
            inputStatusColor.value = color;
            document.querySelectorAll('.color-opt').forEach(el => {
                el.classList.toggle('selected', el.getAttribute('style').includes(color));
            });
        }

        function toggleSidekick() {
            sidekickPanel.classList.toggle('minimized');
            const toggleBtn = sidekickPanel.querySelector('.sidekick-toggle');
            if(sidekickPanel.classList.contains('minimized')) {
                toggleBtn.innerText = "â•";
                skTitle.innerText = "";
            } else {
                toggleBtn.innerText = "â–";
                renderSidekick();
            }
        }

        function renderSidekick() {
            sidekickList.innerHTML = '';
            skTitle.innerText = `é …ç›®åˆ—è¡¨ (${shapes.length})`;
            if(shapes.length === 0) {
                sidekickList.innerHTML = '<div style="text-align:center; color:#999; font-size:0.8em; margin-top:20px;">ç„¡é …ç›®</div>';
                return;
            }
            shapes.forEach((s, idx) => {
                const item = document.createElement('div');
                item.className = `sk-item ${idx === focusedShapeIndex ? 'active' : ''}`;
                item.onclick = () => focusShape(idx);
                const title = s.title || "æœªå‘½å";
                const dotHtml = s.statusColor ? `<span class="status-dot" style="background:${s.statusColor}"></span>` : '';
                item.innerHTML = `
                    <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:120px; font-weight:bold; display:flex; align-items:center;">
                        <span style="color:#999; font-size:0.8em; margin-right:5px;">${idx+1}.</span>${dotHtml}${title}
                    </div>
                    <div class="sk-actions">
                        <button class="sk-btn" onclick="event.stopPropagation(); editShape(${idx})">âœï¸</button>
                        <button class="sk-btn" style="color:red;" onclick="event.stopPropagation(); deleteShape(${idx})">ğŸ—‘ï¸</button>
                    </div>
                `;
                sidekickList.appendChild(item);
            });
        }

        function focusShape(index) {
            focusedShapeIndex = index;
            renderSidekick();
            redraw();
            const center = getShapeCenter(shapes[index]);
            const rect = canvas.getBoundingClientRect();
            window.scrollTo({
                top: (window.scrollY + rect.top + center.y) - (window.innerHeight / 2),
                left: (window.scrollX + rect.left + center.x) - (window.innerWidth / 2),
                behavior: 'smooth'
            });
        }

        // --- V20 æ ¸å¿ƒæŠ€è¡“ï¼šè¨ˆç®—ä¸­å¿ƒé»èˆ‡åç§» ---
        function getShapeCenter(s) {
            if(s.type === 'rect') {
                return {
                    x: (s.start.x + s.end.x) / 2,
                    y: (s.start.y + s.end.y) / 2
                };
            } else {
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                s.points.forEach(p => {
                    minX = Math.min(minX, p.x); maxX = Math.max(maxX, p.x);
                    minY = Math.min(minY, p.y); maxY = Math.max(maxY, p.y);
                });
                return { x: (minX + maxX) / 2, y: (minY + maxY) / 2 };
            }
        }

        function getBadgeOffset(targetIndex) {
            const targetCenter = getShapeCenter(shapes[targetIndex]);
            let overlapCount = 0;
            for(let i = 0; i < targetIndex; i++) {
                const otherCenter = getShapeCenter(shapes[i]);
                const dist = Math.sqrt(Math.pow(targetCenter.x - otherCenter.x, 2) + Math.pow(targetCenter.y - otherCenter.y, 2));
                if(dist < 20) {
                    overlapCount++;
                }
            }
            return { x: overlapCount * 26, y: 0 };
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) ctx.drawImage(image, 0, 0);
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            shapes.forEach((s, idx) => {
                const isActive = (idx === focusedShapeIndex);
                drawShape(s, true, isActive, idx);
            });
            
            if (currentShape && tool === 'rect') drawShape(currentShape, false);
            if (currentShape && tool === 'poly') {
                ctx.beginPath();
                ctx.moveTo(currentShape.points[0].x, currentShape.points[0].y);
                for(let p of currentShape.points) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = '#ff0055'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function drawShape(s, isConfirmed, isActive, index = -1) {
            ctx.beginPath();
            if (s.type === 'rect') {
                const w = s.end.x - s.start.x; const h = s.end.y - s.start.y;
                ctx.rect(s.start.x, s.start.y, w, h);
            } else {
                ctx.moveTo(s.points[0].x, s.points[0].y);
                for(let p of s.points) ctx.lineTo(p.x, p.y); ctx.closePath();
            }
            if(isConfirmed) {
                if(isActive) {
                    ctx.strokeStyle = "#FFD700"; ctx.lineWidth = 4;
                    ctx.fillStyle = "rgba(255, 215, 0, 0.3)";
                } else {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
                }
                ctx.fill(); ctx.stroke();

                let center = getShapeCenter(s);
                let offset = {x:0, y:0};
                if(index !== -1) offset = getBadgeOffset(index);
                
                const badgeX = center.x + offset.x;
                const badgeY = center.y + offset.y;

                ctx.font = "14px sans-serif";
                const textMetrics = ctx.measureText(s.title);
                const hasStatus = !!s.statusColor;
                const padding = hasStatus ? 25 : 12;
                const badgeWidth = textMetrics.width + padding;
                
                ctx.fillStyle = isActive ? "#faad14" : "#28a745"; 
                ctx.beginPath(); ctx.roundRect(badgeX, badgeY - 26, badgeWidth, 24, 4); ctx.fill();
                
                ctx.fillStyle = isActive ? "#000" : "white"; 
                const textX = badgeX + (hasStatus ? 20 : 6);
                ctx.fillText(s.title, textX, badgeY - 8);

                if(hasStatus) {
                    ctx.beginPath();
                    ctx.arc(badgeX + 10, badgeY - 14, 4, 0, Math.PI * 2);
                    ctx.fillStyle = s.statusColor; ctx.fill();
                    ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.lineWidth = 1; ctx.stroke();
                }

                ctx.beginPath();
                ctx.arc(badgeX - 10, badgeY - 15, 10, 0, Math.PI*2);
                ctx.fillStyle = "#333"; ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.lineWidth=1; ctx.stroke();
                ctx.fillStyle = "#fff"; ctx.font = "bold 12px monospace"; ctx.textAlign = "center";
                ctx.fillText(index + 1, badgeX - 10, badgeY - 11);
                ctx.textAlign = "start"; 
            } else {
                ctx.strokeStyle = "#ff0055"; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        function openEditor(shapeData, index) {
            isEditingNote = false; tempShape = shapeData; editingShapeIndex = index;
            document.getElementById('modalTitle').innerText = index === -1 ? "ğŸ“ æ–°å¢å€åŸŸ" : "ğŸ“ ç·¨è¼¯å€åŸŸ";
            document.getElementById('titleGroup').classList.remove('hidden');
            statusGroup.classList.remove('hidden');

            if(index !== -1) {
                duplicateBtnGroup.classList.remove('hidden');
            } else {
                duplicateBtnGroup.classList.add('hidden');
            }

            inputTitle.value = index === -1 ? ("é …ç›® " + (shapes.length + 1)) : shapeData.title;
            inputDesc.value = index === -1 ? "" : shapeData.desc.replace(/<br>/g, '\n');
            inputStatusText.value = shapeData.statusText || "";
            selectColor(shapeData.statusColor || "");

            modal.classList.add('show');
            inputTitle.focus();
        }

        function duplicateShape() {
            if(!tempShape) return;
            const newShape = JSON.parse(JSON.stringify(tempShape));
            newShape.title = (newShape.title || "") + " (è¤‡è£½)";
            newShape.desc = ""; 
            newShape.statusText = "";
            newShape.statusColor = "";

            shapes.push(newShape);
            focusedShapeIndex = shapes.length - 1;
            
            modal.classList.remove('show');
            renderSidekick();
            redraw();
            
            setTimeout(() => {
                openEditor(shapes[focusedShapeIndex], focusedShapeIndex);
            }, 300);
        }

        function editGlobalNote() {
            isEditingNote = true;
            document.getElementById('modalTitle').innerText = "ğŸ“‹ ç·¨è¼¯å°ˆæ¡ˆç­†è¨˜";
            document.getElementById('titleGroup').classList.add('hidden');
            statusGroup.classList.add('hidden');
            duplicateBtnGroup.classList.add('hidden');
            inputDesc.value = globalNote.replace(/<br>/g, '\n');
            modal.classList.add('show');
        }

        function cancelModal() { tempShape = null; modal.classList.remove('show'); redraw(); }

        function saveModal() {
            let formattedDesc = inputDesc.value.replace(/\n/g, '<br>');
            if (isEditingNote) { globalNote = formattedDesc; } 
            else {
                if(!tempShape) return;
                tempShape.title = inputTitle.value || "æœªå‘½å";
                tempShape.desc = formattedDesc;
                tempShape.statusText = inputStatusText.value;
                tempShape.statusColor = inputStatusColor.value;

                if(editingShapeIndex === -1) { shapes.push(tempShape); focusedShapeIndex = shapes.length - 1; } 
                else { shapes[editingShapeIndex] = tempShape; focusedShapeIndex = editingShapeIndex; }
            }
            modal.classList.remove('show');
            renderSidekick(); redraw();
        }

        function addHighlight() {
            const textarea = inputDesc;
            const start = textarea.selectionStart; const end = textarea.selectionEnd;
            if (start === end) return;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + `<span class="highlight-text">${text.substring(start, end)}</span>` + text.substring(end);
        }

        function deleteShape(index) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { shapes.splice(index, 1); focusedShapeIndex = -1; renderSidekick(); redraw(); }
        }
        function editShape(index) { openEditor(shapes[index], index); }
        function undo() { shapes.pop(); renderSidekick(); redraw(); }
        function clearAll() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { shapes = []; globalNote=""; renderSidekick(); redraw(); } }

        function getRegionImage(s) {
            const tCanvas = document.createElement('canvas');
            const tCtx = tCanvas.getContext('2d');
            let x, y, w, h;

            if (s.type === 'rect') {
                x = Math.min(s.start.x, s.end.x); y = Math.min(s.start.y, s.end.y);
                w = Math.abs(s.end.x - s.start.x); h = Math.abs(s.end.y - s.start.y);
            } else {
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                s.points.forEach(p => { minX = Math.min(minX, p.x); maxX = Math.max(maxX, p.x); minY = Math.min(minY, p.y); maxY = Math.max(maxY, p.y); });
                x = minX; y = minY; w = maxX - minX; h = maxY - minY;
            }
            const padding = 10;
            x = Math.max(0, x - padding); y = Math.max(0, y - padding);
            w = w + padding * 2; h = h + padding * 2;

            tCanvas.width = w; tCanvas.height = h;
            tCtx.drawImage(image, x, y, w, h, 0, 0, w, h);
            return tCanvas.toDataURL('image/jpeg', 0.8);
        }

        // --- V21: ä½¿ç”¨ ExcelJS åº«ç”ŸæˆçœŸæ­£çš„ .xlsx (ç„¡è­¦å‘Š) ---
        async function downloadRealExcel() {
            if(shapes.length === 0) { alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºï¼"); return; }
            
            // å‰µå»º Workbook
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet('å°ˆæ¡ˆå ±è¡¨');

            // è¨­å®šæ¬„ä½
            sheet.columns = [
                { header: 'ID', key: 'id', width: 8 },
                { header: 'æˆªåœ–å¿«ç…§', key: 'thumb', width: 25 }, // åœ–ç‰‡æ¬„å¯¬ä¸€é»
                { header: 'æ¨™é¡Œ (é …ç›®)', key: 'title', width: 30 },
                { header: 'ç‹€æ…‹', key: 'status', width: 15 },
                { header: 'è©³ç´°èªªæ˜', key: 'desc', width: 50 }
            ];

            // è¨­å®šæ¨™é ­æ¨£å¼
            sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF444444' } };
            sheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

            // éæ­·æ•¸æ“š
            for (let i = 0; i < shapes.length; i++) {
                const s = shapes[i];
                const rowNum = i + 2; // å› ç‚ºæ¨™é ­æ˜¯ç¬¬ 1 è¡Œ
                
                // è™•ç†æ–‡å­—
                const statusColor = s.statusColor ? s.statusColor.replace('#', '') : 'FFFFFF';
                // åˆ¤æ–·å­—é«”é¡è‰² (æ·±è‰²èƒŒæ™¯é…ç™½å­—)
                const isDark = (statusColor === 'dc3545' || statusColor === '217346' || statusColor === '007bff');
                const fontColor = isDark ? 'FFFFFFFF' : 'FF000000';

                // ç§»é™¤ HTML æ¨™ç±¤
                let cleanDesc = (s.desc || "").replace(/<br>/g, '\n').replace(/<[^>]+>/g, '');

                // åŠ å…¥æ–‡å­—è³‡æ–™
                const row = sheet.getRow(rowNum);
                row.values = {
                    id: i + 1,
                    title: s.title || "",
                    status: s.statusText || "",
                    desc: cleanDesc
                };
                
                // è¨­å®šåˆ—é«˜ (ç‚ºäº†æ”¾åœ–ç‰‡)
                row.height = 60;

                // æ¨£å¼è¨­å®š
                row.getCell('id').alignment = { vertical: 'middle', horizontal: 'center' };
                row.getCell('title').alignment = { vertical: 'middle', wrapText: true };
                row.getCell('desc').alignment = { vertical: 'middle', wrapText: true };
                
                // ç‹€æ…‹æ¬„ä½é¡è‰²
                const statusCell = row.getCell('status');
                statusCell.alignment = { vertical: 'middle', horizontal: 'center' };
                statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + statusColor } };
                statusCell.font = { color: { argb: fontColor }, bold: true };

                // è™•ç†åœ–ç‰‡
                const base64 = getRegionImage(s);
                const imageId = workbook.addImage({
                    base64: base64,
                    extension: 'jpeg',
                });

                // å°‡åœ–ç‰‡åŠ å…¥å·¥ä½œè¡¨ (æµ®å‹•åœ¨ B æ¬„)
                sheet.addImage(imageId, {
                    tl: { col: 1.1, row: rowNum - 1 + 0.1 }, // Top-Left: Bæ¬„ä½å…§ç¸®ä¸€é»
                    br: { col: 1.9, row: rowNum - 0.1 },     // Bottom-Right
                    editAs: 'oneCell' // åœ–ç‰‡éš¨å„²å­˜æ ¼ç§»å‹•
                });
            }

            // å¯«å…¥ Buffer ä¸¦ä¸‹è¼‰
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.href = url;
            
            let rawName = fileNameInput.value.trim();
            if(!rawName) rawName = "project_report_v21";
            link.download = rawName + ".xlsx"; // æ³¨æ„ï¼šç¾åœ¨æ˜¯çœŸæ­£çš„ .xlsx

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPresentation() {
            if(!originalImageDataUrl || shapes.length === 0) { alert("è«‹å…ˆç¹ªè£½ï¼"); return; }
            const restoreData = { imgData: originalImageDataUrl, shapes: shapes, globalNote: globalNote };
            const safeNote = globalNote ? globalNote : "ï¼ˆæ­¤å°ˆæ¡ˆå°šç„¡ç­†è¨˜ï¼‰";
            
            let svgContent = ''; let listItems = '';

            const processedShapes = shapes.map((s, idx) => {
                const center = getShapeCenter(s);
                const offset = getBadgeOffset(idx); 
                return { ...s, cx: center.x, cy: center.y, ox: offset.x, oy: offset.y, id: idx + 1 };
            });

            processedShapes.forEach((s, index) => {
                const id = `region-${index}`;
                let shapeHtml = '';
                
                if(s.type === 'rect') {
                    const w = Math.abs(s.end.x - s.start.x); const h = Math.abs(s.end.y - s.start.y);
                    const x = Math.min(s.start.x, s.end.x); const y = Math.min(s.start.y, s.end.y);
                    shapeHtml = `<rect x="${x}" y="${y}" width="${w}" height="${h}" />`;
                } else {
                    const points = s.points.map(p => `${p.x},${p.y}`).join(' ');
                    shapeHtml = `<polygon points="${points}" />`;
                }

                const badgeCx = s.cx + s.ox;
                const badgeCy = s.cy + s.oy;

                svgContent += `
                    <g id="svg-${id}" class="interactive-group" 
                       onclick="activateRegion('${id}')"
                       onmouseenter="hoverRegion('${id}', true)" 
                       onmouseleave="hoverRegion('${id}', false)">
                        ${shapeHtml}
                        <circle cx="${badgeCx}" cy="${badgeCy}" r="12" class="badge-bg" />
                        <text x="${badgeCx}" y="${badgeCy}" dy="4" text-anchor="middle" class="badge-text">${s.id}</text>
                    </g>`;

                let badgeHtml = '';
                if(s.statusText) {
                    const bgColor = s.statusColor || '#6c757d';
                    badgeHtml = `<span class="status-badge" style="background-color:${bgColor}">${s.statusText}</span>`;
                }

                listItems += `
                    <div class="list-item" id="list-${id}" 
                         onclick="activateRegion('${id}')"
                         onmouseenter="hoverRegion('${id}', true)" 
                         onmouseleave="hoverRegion('${id}', false)">
                        <div class="item-title">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="list-num">${s.id}.</span>
                                ${s.title} ${badgeHtml}
                            </div>
                        </div>
                        <div class="item-desc">${s.desc}</div>
                    </div>`;
            });

            const htmlContent = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>å°ˆæ¡ˆå°è¦½ V21</title><style>
                body { margin:0; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; height: 100vh; display: flex; overflow: hidden; }
                .layout-container { display: flex; width: 100%; height: 100%; }
                .map-section { flex: 3; position: relative; background: #222; overflow: auto; display: flex; justify-content: center; align-items: flex-start; border-right: 1px solid #333; }
                .stage { position: relative; margin-top: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); transform-origin: top center; transition: transform 0.2s; }
                img { display: block; max-width: 100%; }
                .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
                .interactive-group { cursor: pointer; pointer-events: auto; }
                .interactive-group rect, .interactive-group polygon { fill: rgba(255,255,255,0.05); stroke: rgba(255,255,255,0.5); stroke-width: 1; transition: 0.2s; }
                .badge-bg { fill: rgba(0,0,0,0.6); stroke: #fff; stroke-width: 1; transition: 0.2s; }
                .badge-text { fill: #fff; font-size: 12px; font-weight: bold; font-family: sans-serif; pointer-events: none; }
                .interactive-group:hover rect, .interactive-group:hover polygon, .interactive-group.hovered rect, .interactive-group.hovered polygon { stroke: #FFD700; stroke-width: 3; fill: rgba(255, 215, 0, 0.1); }
                .interactive-group:hover .badge-bg, .interactive-group.hovered .badge-bg { fill: #FFD700; stroke: #000; }
                .interactive-group:hover .badge-text, .interactive-group.hovered .badge-text { fill: #000; }
                .interactive-group.active rect, .interactive-group.active polygon { stroke: #28a745; stroke-width: 4; fill: rgba(40,167,69,0.2); animation: pulse 2s infinite; }
                .interactive-group.active .badge-bg { fill: #28a745; stroke: #fff; }
                .interactive-group.active .badge-text { fill: #fff; }
                @keyframes pulse { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.5; } 100% { stroke-opacity: 1; } }
                .sidebar { flex: 1; min-width: 350px; max-width: 450px; background: #2b2b2b; color: #fff; display: flex; flex-direction: column; z-index: 20; border-left: 1px solid #444; }
                .sidebar-header { padding: 15px 20px; background: #333; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
                .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
                .list-item { background: #383838; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
                .list-item:hover, .list-item.hovered { background: #444; border-left-color: #FFD700; }
                .list-item.active { background: #444; border-left-color: #28a745; box-shadow: 0 0 15px rgba(40,167,69,0.2); }
                .item-title { padding: 12px 15px; font-weight: bold; font-size: 1.05em; display: flex; justify-content: space-between; align-items: center; }
                .list-num { color: #888; margin-right: 5px; font-family: monospace; }
                .list-item.active .list-num { color: #28a745; }
                .item-desc { padding: 0 15px; max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s; color: #ddd; line-height: 1.6; font-size: 0.95em; border-top: 1px solid rgba(255,255,255,0.05); }
                .list-item.active .item-desc { padding: 15px; max-height: 800px; opacity: 1; }
                .status-badge { font-size: 0.75em; color: #fff; padding: 2px 8px; border-radius: 10px; vertical-align: middle; }
                .zoom-controls { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 100; }
                .zoom-btn { background: rgba(0,0,0,0.7); color: white; border: 1px solid #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
                .zoom-btn:hover { background: #28a745; border-color: #28a745; }
                .note-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
                .note-card { background: #2b2b2b; color: #eee; width: 80%; max-width: 700px; max-height: 80vh; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #555; }
                .note-body { padding: 30px; overflow-y: auto; line-height: 1.8; font-size: 1.1em; white-space: pre-wrap; }
            </style></head><body><div class="layout-container"><div class="map-section" id="mapSection"><div class="stage" id="stage" style="width: 95%;"><img src="${originalImageDataUrl}"><svg class="overlay" viewBox="0 0 ${canvas.width} ${canvas.height}">${svgContent}</svg></div><div class="zoom-controls"><button class="zoom-btn" onclick="setZoom(100)">100%</button><button class="zoom-btn" onclick="setZoom('fit')">Fit</button><button class="zoom-btn" onclick="zoomIn()">+</button><button class="zoom-btn" onclick="zoomOut()">-</button></div></div><div class="sidebar"><div class="sidebar-header"><div style="font-size:1.2em; font-weight:bold; color:#28a745;">ğŸ“‹ å°ˆæ¡ˆå°è¦½</div><button style="background:#6610f2; color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer;" onclick="toggleNote()">å°ˆæ¡ˆç­†è¨˜</button></div><div class="sidebar-content" id="sidebarList">${listItems}</div></div></div><div class="note-modal" id="noteModal" onclick="toggleNote()"><div class="note-card" onclick="event.stopPropagation()"><div style="padding:15px 20px; border-bottom:1px solid #444; font-weight:bold; background:#333; border-radius:12px 12px 0 0;">ğŸ“Œ å°ˆæ¡ˆç­†è¨˜</div><div class="note-body">${safeNote}</div></div></div><script id="restore-data" type="application/json">${JSON.stringify(restoreData)}<\/script><script>let currentZoom = 95; const stage = document.getElementById('stage'); function updateZoom() { stage.style.width = currentZoom + '%'; } function zoomIn() { currentZoom += 10; updateZoom(); } function zoomOut() { if(currentZoom > 20) currentZoom -= 10; updateZoom(); } function setZoom(val) { currentZoom = (val === 'fit') ? 95 : 100; updateZoom(); } let activeId = null; function activateRegion(id) { if(activeId === id) { deactivate(); return; } if(activeId) deactivate(); activeId = id; document.getElementById('svg-' + id)?.classList.add('active'); const listItem = document.getElementById('list-' + id); listItem?.classList.add('active'); listItem?.scrollIntoView({ behavior: 'smooth', block: 'center' }); } function deactivate() { if(!activeId) return; document.getElementById('svg-' + activeId)?.classList.remove('active'); document.getElementById('list-' + activeId)?.classList.remove('active'); activeId = null; } function hoverRegion(id, isEnter) { if(activeId === id) return; const svgEl = document.getElementById('svg-' + id); const listEl = document.getElementById('list-' + id); if(isEnter) { svgEl?.classList.add('hovered'); listEl?.classList.add('hovered'); } else { svgEl?.classList.remove('hovered'); listEl?.classList.remove('hovered'); } } function toggleNote() { const m = document.getElementById('noteModal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; } <\/script></body></html>`;

            const blob = new Blob([htmlContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            let rawName = fileNameInput.value.trim();
            if(!rawName) rawName = "dashboard_v21";
            link.download = rawName + ".html";
            link.click();
        }
    </script>
</body>
</html>
